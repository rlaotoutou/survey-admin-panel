<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调查问卷数据管理面板</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-flex;
            align-items: center;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-table {
            font-size: 14px;
        }
        .data-table th,
        .data-table td {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 标题和配置 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">调查问卷数据管理面板</h1>
            
            <!-- API 配置 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">API 地址</label>
                    <input type="url" id="apiUrl" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="https://your-app.onrender.com">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">管理员密钥</label>
                    <input type="password" id="adminKey" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="请输入ADMIN_KEY">
                </div>
                <div class="flex items-end">
                    <button id="loadData" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <div class="loading">
                            <div class="spinner"></div>
                            加载中...
                        </div>
                        <span class="load-text">
                            <i class="fas fa-sync mr-2"></i>加载数据
                        </span>
                    </button>
                </div>
            </div>

            <!-- 状态显示 -->
            <div id="statusDisplay" class="p-3 rounded-lg mb-4 hidden">
                <div class="flex items-center">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full mr-2"></div>
                    <span id="statusText"></span>
                </div>
            </div>

            <!-- 统计信息 -->
            <div id="statsSection" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-blue-600 text-sm font-medium">总记录数</div>
                        <div id="totalCount" class="text-2xl font-bold text-blue-800">0</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-green-600 text-sm font-medium">当前显示</div>
                        <div id="currentCount" class="text-2xl font-bold text-green-800">0</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-purple-600 text-sm font-medium">最新记录</div>
                        <div id="latestRecord" class="text-sm font-medium text-purple-800">-</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-orange-600 text-sm font-medium">操作</div>
                        <button id="exportCSV" class="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600">
                            <i class="fas fa-download mr-1"></i>导出CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分页控制 -->
            <div id="paginationSection" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-700">每页显示:</label>
                        <select id="limitSelect" class="px-3 py-1 border rounded">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prevPage" class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i> 上一页
                        </button>
                        <span id="pageInfo" class="text-gray-600">页 1</span>
                        <button id="nextPage" class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50">
                            下一页 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">调查数据</h2>
            </div>
            <div class="overflow-x-auto">
                <div id="dataContainer" class="p-8 text-center text-gray-500">
                    <i class="fas fa-database text-4xl mb-4"></i>
                    <p>请先配置API地址和管理员密钥，然后点击"加载数据"</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentPage = 1;
        let totalRecords = 0;
        let limit = 25;

        const apiUrl = document.getElementById('apiUrl');
        const adminKey = document.getElementById('adminKey');
        const loadData = document.getElementById('loadData');
        const statusDisplay = document.getElementById('statusDisplay');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const statsSection = document.getElementById('statsSection');
        const paginationSection = document.getElementById('paginationSection');
        const dataContainer = document.getElementById('dataContainer');
        const totalCount = document.getElementById('totalCount');
        const currentCount = document.getElementById('currentCount');
        const latestRecord = document.getElementById('latestRecord');
        const exportCSV = document.getElementById('exportCSV');
        const limitSelect = document.getElementById('limitSelect');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');

        // 事件监听器
        loadData.addEventListener('click', loadSurveyData);
        exportCSV.addEventListener('click', downloadCSV);
        limitSelect.addEventListener('change', (e) => {
            limit = parseInt(e.target.value);
            currentPage = 1;
            loadSurveyData();
        });
        prevPage.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadSurveyData();
            }
        });
        nextPage.addEventListener('click', () => {
            currentPage++;
            loadSurveyData();
        });

        // 加载数据
        async function loadSurveyData() {
            const api = apiUrl.value.trim();
            const key = adminKey.value.trim();

            if (!api || !key) {
                showStatus('error', '请输入API地址和管理员密钥');
                return;
            }

            toggleLoading(true);
            showStatus('checking', '正在加载数据...');

            try {
                const offset = (currentPage - 1) * limit;
                const response = await fetch(`${api}/api/surveys?limit=${limit}&offset=${offset}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': key,
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(30000)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentData = data.rows || [];
                    totalRecords = data.total || 0;
                    
                    displayData();
                    updateStats();
                    updatePagination();
                    showStatus('connected', `成功加载 ${currentData.length} 条记录`);
                    
                    statsSection.classList.remove('hidden');
                    paginationSection.classList.remove('hidden');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                let errorMessage = '加载失败: ';
                
                if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                    errorMessage += '请求超时';
                } else if (error.message.includes('401')) {
                    errorMessage += '管理员密钥错误';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'CORS错误';
                } else {
                    errorMessage += error.message;
                }
                
                showStatus('error', errorMessage);
                dataContainer.innerHTML = `
                    <div class="p-8 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>${errorMessage}</p>
                    </div>
                `;
            } finally {
                toggleLoading(false);
            }
        }

        // 显示数据
        function displayData() {
            if (currentData.length === 0) {
                dataContainer.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>暂无数据</p>
                    </div>
                `;
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table w-full';

            // 表头
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>ID</th>
                    <th>提交时间</th>
                    <th>门店名称</th>
                    <th>业态类型</th>
                    <th>月营收</th>
                    <th>食材成本</th>
                    <th>人力成本</th>
                    <th>租金成本</th>
                    <th>日均客流</th>
                    <th>座位数</th>
                    <th>操作</th>
                </tr>
            `;
            table.appendChild(thead);

            // 表体
            const tbody = document.createElement('tbody');
            currentData.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${formatDate(record.timestamp)}</td>
                    <td>${record.store_name || '-'}</td>
                    <td>${record.business_type || '-'}</td>
                    <td>${formatNumber(record.monthly_revenue)}</td>
                    <td>${formatNumber(record.food_cost)}</td>
                    <td>${formatNumber(record.labor_cost)}</td>
                    <td>${formatNumber(record.rent_cost)}</td>
                    <td>${record.daily_customers || '-'}</td>
                    <td>${record.seats || '-'}</td>
                    <td>
                        <button onclick="viewRecord(${record.id})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            dataContainer.innerHTML = '';
            dataContainer.appendChild(table);
        }

        // 更新统计信息
        function updateStats() {
            totalCount.textContent = totalRecords.toLocaleString();
            currentCount.textContent = currentData.length;
            
            if (currentData.length > 0) {
                const latest = new Date(currentData[0].timestamp).toLocaleDateString();
                latestRecord.textContent = latest;
            }
        }

        // 更新分页信息
        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / limit);
            pageInfo.textContent = `页 ${currentPage} / ${totalPages}`;
            
            prevPage.disabled = currentPage <= 1;
            nextPage.disabled = currentPage >= totalPages;
        }

        // 查看单条记录详情
        function viewRecord(id) {
            const record = currentData.find(r => r.id === id);
            if (!record) return;

            const details = `
                记录ID: ${record.id}
                提交时间: ${formatDate(record.timestamp)}
                
                基础信息:
                门店名称: ${record.store_name || '-'}
                业态类型: ${record.business_type || '-'}
                月营收: ${formatNumber(record.monthly_revenue)}
                食材成本: ${formatNumber(record.food_cost)}
                人力成本: ${formatNumber(record.labor_cost)}
                租金成本: ${formatNumber(record.rent_cost)}
                日均客流: ${record.daily_customers || '-'}
                座位数: ${record.seats || '-'}
                
                运营数据:
                线上营收: ${formatNumber(record.online_revenue)}
                营销费用: ${formatNumber(record.marketing_cost)}
                复购次数: ${record.repeat_purchases || '-'}
                总客流: ${record.total_customers || '-'}
                水电费: ${formatNumber(record.utility_cost)}
                
                体验数据:
                平均评分: ${record.average_rating || '-'}
                差评数: ${record.bad_reviews || '-'}
                总评论数: ${record.total_reviews || '-'}
                社媒提及: ${record.social_media_mentions || '-'}
                服务差评率: ${record.service_bad_review_rate || '-'}%
                口味差评率: ${record.taste_bad_review_rate || '-'}%
                
                技术信息:
                IP地址: ${record.ip || '-'}
                用户代理: ${record.user_agent || '-'}
            `;

            alert(details);
        }

        // 下载CSV
        async function downloadCSV() {
            const api = apiUrl.value.trim();
            const key = adminKey.value.trim();

            if (!api || !key) {
                alert('请先配置API地址和管理员密钥');
                return;
            }

            try {
                const response = await fetch(`${api}/api/export`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': key
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `surveys_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                alert('导出失败: ' + error.message);
            }
        }

        // 显示状态
        function showStatus(type, message) {
            statusText.textContent = message;
            statusDisplay.className = 'p-3 rounded-lg mb-4';
            statusIndicator.className = 'w-3 h-3 rounded-full mr-2';

            switch(type) {
                case 'connected':
                    statusDisplay.classList.add('bg-green-100', 'text-green-800');
                    statusIndicator.classList.add('bg-green-500');
                    break;
                case 'checking':
                    statusDisplay.classList.add('bg-yellow-100', 'text-yellow-800');
                    statusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'error':
                    statusDisplay.classList.add('bg-red-100', 'text-red-800');
                    statusIndicator.classList.add('bg-red-500');
                    break;
            }
            statusDisplay.classList.remove('hidden');
        }

        // 切换加载状态
        function toggleLoading(loading) {
            const loadingElement = loadData.querySelector('.loading');
            const textElement = loadData.querySelector('.load-text');
            
            if (loading) {
                loadingElement.classList.add('active');
                textElement.style.display = 'none';
                loadData.disabled = true;
            } else {
                loadingElement.classList.remove('active');
                textElement.style.display = 'flex';
                loadData.disabled = false;
            }
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('zh-CN');
        }

        // 格式化数字
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString();
        }
    </script>
</body>
</html>