<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐饮店数据管理与AI诊断系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-flex;
            align-items: center;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-table {
            font-size: 14px;
        }
        .data-table th,
        .data-table td {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .health-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .health-table th, .health-table td {
            border: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
        }
        .health-table th {
            background-color: #3498db;
            color: white;
        }
        .status-healthy {
            background-color: #d4edda !important;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd !important;
            color: #856404;
        }
        .status-danger {
            background-color: #f8d7da !important;
            color: #721c24;
        }
        .action-plans {
            list-style: none;
            padding: 0;
        }
        .action-plans li {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        .priority-high { border-left-color: #e74c3c; }
        .priority-medium { border-left-color: #f39c12; }
        .priority-low { border-left-color: #2ecc71; }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .radar-chart {
            max-width: 400px;
            margin: 0 auto;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .metric-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        .steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50px;
            right: 50px;
            height: 4px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e0e0e0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }
        .step.active {
            background-color: #3498db;
        }
        .step.completed {
            background-color: #2ecc71;
        }
        .step-label {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 14px;
            color: #555;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10b981;
        }
        .notification.error {
            background-color: #ef4444;
        }
        .notification.warning {
            background-color: #f59e0b;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <!-- 通知组件 -->
    <div id="notification" class="notification"></div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 导航标签 -->
        <div class="bg-white rounded-2xl shadow-xl mb-8 overflow-hidden">
            <div class="gradient-bg p-1">
                <div class="flex bg-white rounded-xl">
                    <button id="dataTab" class="tab-btn flex-1 py-4 px-6 text-center font-semibold text-blue-600 border-b-2 border-blue-600 bg-blue-50 rounded-l-xl transition-all duration-300">
                        <i class="fas fa-database mr-2"></i>数据管理
                    </button>
                    <button id="diagnosisTab" class="tab-btn flex-1 py-4 px-6 text-center font-semibold text-gray-500 hover:text-blue-600 hover:bg-gray-50 rounded-r-xl transition-all duration-300">
                        <i class="fas fa-stethoscope mr-2"></i>AI诊断
                    </button>
                </div>
            </div>
        </div>

        <!-- 数据管理页面 -->
        <div id="dataContent" class="tab-content active">
            <!-- 配置区域 -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-6">调查问卷数据管理面板</h1>
                
                <!-- API配置 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">API地址</label>
                        <input type="url" id="apiUrl" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                               placeholder="https://your-app.onrender.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">管理员密钥</label>
                        <input type="password" id="adminKey" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
                               placeholder="请输入ADMIN_KEY">
                    </div>
                    <div class="flex items-end">
                        <button id="loadData" class="w-full px-6 py-3 btn-primary text-white rounded-xl font-semibold">
                            <div class="loading">
                                <div class="spinner"></div>
                                加载中...
                            </div>
                            <span class="load-text">
                                <i class="fas fa-sync mr-2"></i>加载数据
                            </span>
                        </button>
                    </div>
                </div>

                <!-- 状态显示 -->
                <div id="statusDisplay" class="p-4 rounded-xl mb-6 hidden">
                    <div class="flex items-center">
                        <div id="statusIndicator" class="w-3 h-3 rounded-full mr-3"></div>
                        <span id="statusText"></span>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div id="statsSection" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
                        <div class="metric-card p-6 rounded-xl card-hover">
                            <div class="text-blue-600 text-sm font-medium mb-2">总记录数</div>
                            <div id="totalCount" class="text-3xl font-bold text-blue-800">0</div>
                            <div class="text-xs text-gray-500 mt-1">All Records</div>
                        </div>
                        <div class="metric-card p-6 rounded-xl card-hover">
                            <div class="text-green-600 text-sm font-medium mb-2">当前显示</div>
                            <div id="currentCount" class="text-3xl font-bold text-green-800">0</div>
                            <div class="text-xs text-gray-500 mt-1">Current Page</div>
                        </div>
                        <div class="metric-card p-6 rounded-xl card-hover">
                            <div class="text-purple-600 text-sm font-medium mb-2">最新记录</div>
                            <div id="latestRecord" class="text-lg font-medium text-purple-800">-</div>
                            <div class="text-xs text-gray-500 mt-1">Latest Entry</div>
                        </div>
                        <div class="metric-card p-6 rounded-xl card-hover">
                            <div class="text-orange-600 text-sm font-medium mb-2">导出操作</div>
                            <button id="exportCSV" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-all duration-300 text-sm font-medium">
                                <i class="fas fa-download mr-1"></i>导出CSV
                            </button>
                        </div>
                        <div class="metric-card p-6 rounded-xl card-hover">
                            <div class="text-red-600 text-sm font-medium mb-2">批量诊断</div>
                            <button id="batchDiagnosis" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-300 text-sm font-medium">
                                <i class="fas fa-magic mr-1"></i>批量分析
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 分页控制 -->
                <div id="paginationSection" class="hidden">
                    <div class="flex items-center justify-between mb-6 bg-gray-50 p-4 rounded-xl">
                        <div class="flex items-center space-x-3">
                            <label class="text-gray-700 font-medium">每页显示:</label>
                            <select id="limitSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button id="prevPage" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 transition-all duration-300" disabled>
                                <i class="fas fa-chevron-left mr-1"></i>上一页
                            </button>
                            <span id="pageInfo" class="text-gray-600 font-medium px-3">页 1</span>
                            <button id="nextPage" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 disabled:opacity-50 transition-all duration-300">
                                下一页<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden card-hover">
                <div class="gradient-bg p-6 text-white">
                    <h2 class="text-xl font-bold">调查数据</h2>
                    <p class="text-blue-100 mt-1">Restaurant Survey Data</p>
                </div>
                <div class="overflow-x-auto">
                    <div id="dataContainer" class="p-12 text-center text-gray-500">
                        <i class="fas fa-database text-6xl mb-6 text-gray-300"></i>
                        <p class="text-xl">请先配置API地址和管理员密钥，然后点击"加载数据"</p>
                        <p class="text-sm text-gray-400 mt-2">Configure API settings to load restaurant survey data</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI诊断页面 -->
        <div id="diagnosisContent" class="tab-content">
            <!-- 选择数据源 -->
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover">
                <h1 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-6">餐饮店AI诊断系统</h1>
                
                <div class="mb-6">
                    <div class="flex items-center space-x-6">
                        <label class="text-gray-700 font-medium text-lg">选择诊断数据来源：</label>
                        <div class="flex space-x-6">
                            <label class="flex items-center bg-blue-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-100 transition-all duration-300">
                                <input type="radio" name="dataSource" value="manual" checked class="mr-3">
                                <span class="font-medium">手动输入数据</span>
                            </label>
                            <label class="flex items-center bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100 transition-all duration-300">
                                <input type="radio" name="dataSource" value="api" class="mr-3">
                                <span class="font-medium">使用API数据</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="apiDataSelector" class="hidden bg-gray-50 p-6 rounded-xl">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-3">选择要诊断的记录：</label>
                        <select id="recordSelect" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="">请选择一条记录进行诊断</option>
                        </select>
                    </div>
                    <button id="loadSelectedRecord" class="bg-blue-500 text-white px-6 py-3 rounded-xl hover:bg-blue-600 font-medium transition-all duration-300">
                        <i class="fas fa-upload mr-2"></i>载入选中记录
                    </button>
                </div>
            </div>

            <!-- 分步表单 -->
            <div id="manualForm" class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover">
                <div class="progress-text text-center mb-6">步骤 <span id="currentStep">1</span>/3</div>
                <div class="steps">
                    <div class="step active" data-step="1">1<span class="step-label">基础信息</span></div>
                    <div class="step" data-step="2">2<span class="step-label">运营数据</span></div>
                    <div class="step" data-step="3">3<span class="step-label">体验数据</span></div>
                </div>

                <!-- 步骤1: 基础信息 -->
                <div class="form-step active" id="step1">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-store mr-3 text-blue-600"></i>基础信息
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">门店名称 *</label>
                            <input type="text" id="storeName" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：朝阳路快餐店">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">业态类型 *</label>
                            <select id="storeType" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                                <option value="">请选择业态类型</option>
                                <option value="快餐">快餐</option>
                                <option value="火锅">火锅</option>
                                <option value="正餐">正餐</option>
                                <option value="茶餐厅">茶餐厅</option>
                                <option value="自助餐">自助餐</option>
                                <option value="烧烤">烧烤</option>
                                <option value="麻辣烫">麻辣烫</option>
                                <option value="面条">面条</option>
                                <option value="包子饺子">包子饺子</option>
                                <option value="粥店">粥店</option>
                                <option value="咖啡厅">咖啡厅</option>
                                <option value="茶饮店">茶饮店</option>
                                <option value="甜品店">甜品店</option>
                                <option value="西餐厅">西餐厅</option>
                                <option value="日韩料理">日韩料理</option>
                                <option value="东南亚菜">东南亚菜</option>
                                <option value="小吃摊档">小吃摊档</option>
                                <option value="食堂档口">食堂档口</option>
                                <option value="酒吧">酒吧</option>
                                <option value="夜宵店">夜宵店</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">营业收入（元/月）*</label>
                            <input type="number" id="revenue" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：150000" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">食材成本（元/月）*</label>
                            <input type="number" id="foodCost" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：60000" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">人力成本（元/月）*</label>
                            <input type="number" id="laborCost" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：50000" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">租金成本（元/月）*</label>
                            <input type="number" id="rentCost" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：30000" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">日均客流（人/天）*</label>
                            <input type="number" id="dailyCustomers" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：150" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">座位数（个）*</label>
                            <input type="number" id="seats" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：50" min="1">
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button type="button" id="prevBtn1" disabled class="px-6 py-3 bg-gray-300 text-gray-500 rounded-xl cursor-not-allowed">上一步</button>
                        <button type="button" id="nextBtn1" class="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all duration-300">下一步</button>
                    </div>
                </div>

                <!-- 步骤2: 运营数据 -->
                <div class="form-step" id="step2">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-chart-line mr-3 text-green-600"></i>运营数据
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">线上营收（元/月）*</label>
                            <input type="number" id="takeawayRevenue" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：60000" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">营销费用（元/月）*</label>
                            <input type="number" id="marketingCost" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：15000" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">老客户复购次数（次/月）*</label>
                            <input type="number" id="memberRepurchase" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：30" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">总客流（人/月）*</label>
                            <input type="number" id="totalCustomers" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：4500" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">水电气成本（元/月）*</label>
                            <input type="number" id="energyCost" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：8000" min="0">
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button type="button" id="prevBtn2" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all duration-300">上一步</button>
                        <button type="button" id="nextBtn2" class="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all duration-300">下一步</button>
                    </div>
                </div>

                <!-- 步骤3: 体验数据 -->
                <div class="form-step" id="step3">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-star mr-3 text-yellow-600"></i>体验数据
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">各平台团购均评分（0-5分）*</label>
                            <input type="number" id="reviewScore" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：3.8" min="0" max="5" step="0.1">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">差评数（条/月）*</label>
                            <input type="number" id="negativeComments" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：25" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">总评论数（条/月）*</label>
                            <input type="number" id="totalComments" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：400" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">社交媒体提及量（次/条）*</label>
                            <input type="number" id="socialMentions" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：80" min="0">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">服务差评占比（%）*</label>
                            <input type="number" id="serviceComplaints" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：40" min="0" max="100">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-3">口味差评占比（%）*</label>
                            <input type="number" id="tasteComplaints" required class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300" placeholder="例如：30" min="0" max="100">
                        </div>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button type="button" id="prevBtn3" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all duration-300">上一步</button>
                        <button type="button" id="generateReport" class="px-8 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-xl hover:from-green-600 hover:to-blue-600 text-lg font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                            <i class="fas fa-magic mr-2"></i>生成AI诊断报告
                        </button>
                    </div>
                </div>

                <!-- 加载动画 -->
                <div id="loadingSection" class="text-center py-12 hidden">
                    <div class="spinner mx-auto w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-6"></div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">正在生成诊断报告...</h3>
                    <p class="text-gray-500">AI正在分析您的数据，请稍候...</p>
                </div>
            </div>

            <!-- 诊断报告区域 -->
            <div id="reportContainer" class="hidden">
                <div class="bg-white rounded-2xl shadow-xl p-8 card-hover">
                    <h2 class="text-3xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-8">餐饮店盈利诊断报告及改进建议</h2>
                    
                    <!-- 健康状态红绿灯 -->
                    <div class="mb-10">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-heartbeat mr-3 text-red-500"></i>一、健康状态红绿灯
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="health-table w-full">
                                <thead>
                                    <tr>
                                        <th>核心指标</th>
                                        <th>门店数值</th>
                                        <th>健康状态</th>
                                        <th>通俗解读</th>
                                    </tr>
                                </thead>
                                <tbody id="healthTableBody">
                                    <!-- 动态生成内容 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 行业对比雷达图 -->
                    <div class="mb-10">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-chart-radar mr-3 text-blue-500"></i>二、行业对比分析
                        </h3>
                        <div class="text-center bg-gray-50 p-6 rounded-xl">
                            <canvas id="radarChart" class="radar-chart" width="400" height="400"></canvas>
                        </div>
                        <div id="industryComparison" class="mt-6"></div>
                    </div>

                    <!-- 问题根因分析 -->
                    <div class="mb-10">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-search mr-3 text-yellow-500"></i>三、问题根因分析
                        </h3>
                        <div id="rootCauseAnalysis"></div>
                    </div>

                    <!-- 老板行动指南 -->
                    <div class="mb-10">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-tasks mr-3 text-green-500"></i>四、老板行动指南
                        </h3>
                        <ul class="action-plans" id="actionPlans"></ul>
                        <div id="keyRecommendation" class="mt-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-l-4 border-blue-500"></div>
                    </div>

                    <!-- 下载报告 -->
                    <div class="text-center mt-10 p-8 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center justify-center">
                            <i class="fas fa-download mr-2 text-blue-600"></i>报告下载
                        </h3>
                        <p class="text-gray-600 mb-6">点击下方按钮下载完整的诊断报告（HTML格式）</p>
                        <a href="#" class="inline-block bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-xl hover:from-blue-600 hover:to-purple-600 font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" id="downloadLink">
                            <i class="fas fa-download mr-2"></i>下载完整报告
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentData = [];
        let currentPage = 1;
        let totalRecords = 0;
        let limit = 25;
        let selectedRecord = null;
        let currentDiagnosisStep = 1;

        // 诊断系统类
        class RestaurantDiagnosis {
            constructor() {
                this.thresholds = {
                    food_cost_ratio: 0.35,
                    labor_cost_ratio: 0.30,
                    rent_cost_ratio: 0.20,
                    marketing_cost_ratio: 0.10,
                    gross_margin: 0.55,
                    table_turnover: 3.0,
                    takeaway_ratio: [0.3, 0.5],
                    member_repurchase: 0.25,
                    energy_cost_ratio: 0.05,
                    review_score: 4.0,
                    negative_comment_rate: 0.05,
                    social_mention: 100,
                    service_complaint_rate: 0.30,
                    taste_complaint_rate: 0.30
                };

                this.industryBenchmarks = {
                    '快餐': { table_turnover: 4.5, gross_margin: 0.60, takeaway_ratio: 0.4 },
                    '火锅': { table_turnover: 3.5, gross_margin: 0.65, takeaway_ratio: 0.3 },
                    '正餐': { table_turnover: 2.5, gross_margin: 0.58, takeaway_ratio: 0.25 },
                    '茶餐厅': { table_turnover: 3.0, gross_margin: 0.55, takeaway_ratio: 0.3 },
                    '自助餐': { table_turnover: 2.0, gross_margin: 0.50, takeaway_ratio: 0.1 },
                    '烧烤': { table_turnover: 3.0, gross_margin: 0.62, takeaway_ratio: 0.35 },
                    '麻辣烫': { table_turnover: 4.0, gross_margin: 0.58, takeaway_ratio: 0.5 },
                    '面条': { table_turnover: 4.5, gross_margin: 0.60, takeaway_ratio: 0.45 },
                    '包子饺子': { table_turnover: 4.0, gross_margin: 0.55, takeaway_ratio: 0.4 },
                    '粥店': { table_turnover: 4.0, gross_margin: 0.52, takeaway_ratio: 0.5 },
                    '咖啡厅': { table_turnover: 2.0, gross_margin: 0.70, takeaway_ratio: 0.4 },
                    '茶饮店': { table_turnover: 5.0, gross_margin: 0.65, takeaway_ratio: 0.6 },
                    '甜品店': { table_turnover: 3.5, gross_margin: 0.68, takeaway_ratio: 0.45 },
                    '西餐厅': { table_turnover: 2.0, gross_margin: 0.60, takeaway_ratio: 0.2 },
                    '日韩料理': { table_turnover: 2.5, gross_margin: 0.62, takeaway_ratio: 0.3 },
                    '东南亚菜': { table_turnover: 2.5, gross_margin: 0.58, takeaway_ratio: 0.25 },
                    '小吃摊档': { table_turnover: 6.0, gross_margin: 0.50, takeaway_ratio: 0.3 },
                    '食堂档口': { table_turnover: 5.0, gross_margin: 0.45, takeaway_ratio: 0.1 },
                    '酒吧': { table_turnover: 1.5, gross_margin: 0.75, takeaway_ratio: 0.1 },
                    '夜宵店': { table_turnover: 3.0, gross_margin: 0.60, takeaway_ratio: 0.4 },
                    '其他': { table_turnover: 3.0, gross_margin: 0.55, takeaway_ratio: 0.3 }
                };
            }

            calculateKPI(inputData) {
                return {
                    food_cost_ratio: inputData.食材成本 / inputData.营业收入,
                    labor_cost_ratio: inputData.人力成本 / inputData.营业收入,
                    rent_cost_ratio: inputData.租金成本 / inputData.营业收入,
                    marketing_cost_ratio: inputData.营销费用 / inputData.营业收入,
                    gross_margin: 1 - (inputData.食材成本 + inputData.人力成本 + inputData.租金成本 + inputData.营销费用 + inputData.水电气成本) / inputData.营业收入,
                    table_turnover: inputData.日均客流 / inputData.座位数,
                    takeaway_ratio: inputData.线上营收 / inputData.营业收入,
                    member_repurchase: inputData.老客户复购次数 / inputData.总客流,
                    energy_cost_ratio: inputData.水电气成本 / inputData.营业收入,
                    review_score: inputData.各平台团购均评分,
                    negative_comment_rate: inputData.差评数 / inputData.总评论数,
                    social_mention: inputData.社交媒体提及量,
                    service_complaint_rate: inputData.服务差评占比 / 100,
                    taste_complaint_rate: inputData.口味差评占比 / 100
                };
            }

            diagnose(inputData) {
                const kpi = this.calculateKPI(inputData);
                const report = {
                    healthCheck: {},
                    rootCauses: [],
                    actionPlans: [],
                    industryComparison: {}
                };

                // 健康检查
                const indicators = {
                    'food_cost_ratio': '食材成本率',
                    'labor_cost_ratio': '人力成本率', 
                    'rent_cost_ratio': '租金成本率',
                    'marketing_cost_ratio': '营销成本率',
                    'gross_margin': '毛利率',
                    'table_turnover': '翻台率',
                    'takeaway_ratio': '线上占比',
                    'member_repurchase': '会员复购率',
                    'energy_cost_ratio': '水电气成本率',
                    'review_score': '团购评分',
                    'negative_comment_rate': '差评率',
                    'service_complaint_rate': '服务差评率',
                    'taste_complaint_rate': '口味差评率'
                };

                for (const [key, name] of Object.entries(indicators)) {
                    const value = kpi[key];
                    const threshold = this.thresholds[key];
                    let status = '健康', statusClass = 'status-healthy';

                    if (Array.isArray(threshold)) {
                        if (value < threshold[0] || value > threshold[1]) {
                            status = '异常';
                            statusClass = 'status-danger';
                        }
                    } else {
                        if ((key === 'gross_margin' || key === 'review_score' || key === 'member_repurchase') && value < threshold) {
                            status = '偏低';
                            statusClass = 'status-warning';
                        } else if ((key !== 'gross_margin' && key !== 'review_score' && key !== 'member_repurchase') && value > threshold) {
                            status = '偏高';
                            statusClass = 'status-danger';
                        }
                    }

                    report.healthCheck[key] = {
                        name,
                        value: this.formatValue(key, value),
                        rawValue: value,
                        status,
                        statusClass,
                        interpretation: this.getInterpretation(key, value)
                    };
                }

                // 根因分析
                if (kpi.negative_comment_rate > this.thresholds.negative_comment_rate) {
                    report.rootCauses.push({
                        phenomenon: '差评率过高',
                        causes: [
                            `服务问题（占差评${inputData.服务差评占比 || 40}%）`,
                            `口味问题（占差评${inputData.口味差评占比 || 30}%）`
                        ],
                        dataSupport: `近30天差评${inputData.差评数}条，差评率${(kpi.negative_comment_rate * 100).toFixed(1)}%`
                    });
                }

                if (kpi.table_turnover < this.thresholds.table_turnover) {
                    report.rootCauses.push({
                        phenomenon: '翻台率偏低',
                        causes: [
                            '用餐时间过长',
                            '座位利用率不高',
                            '服务效率待提升'
                        ],
                        dataSupport: `当前翻台率${kpi.table_turnover.toFixed(1)}次/天，低于行业标准${this.thresholds.table_turnover}次`
                    });
                }

                if (kpi.marketing_cost_ratio > this.thresholds.marketing_cost_ratio) {
                    report.rootCauses.push({
                        phenomenon: '营销成本过高',
                        causes: [
                            '广告投放效率低',
                            '代运营费用高',
                            '获客成本上升'
                        ],
                        dataSupport: `营销成本占比${(kpi.marketing_cost_ratio * 100).toFixed(1)}%，超过建议上限${this.thresholds.marketing_cost_ratio * 100}%`
                    });
                }

                // 行动建议
                report.actionPlans.push({
                    problem: '服务差评率高',
                    solutions: [
                        {
                            measure: '加强服务培训，制定服务标准',
                            cost: '5000元/月',
                            effect: '服务差评率下降30%，整体评分提升0.2分',
                            priority: '高',
                            priorityClass: 'priority-high'
                        },
                        {
                            measure: '优化点餐流程，减少等待时间',
                            cost: '8000元',
                            effect: '用餐体验提升，翻台率增加15%',
                            priority: '中',
                            priorityClass: 'priority-medium'
                        }
                    ]
                });

                if (kpi.marketing_cost_ratio > this.thresholds.marketing_cost_ratio) {
                    report.actionPlans.push({
                        problem: '营销成本过高',
                        solutions: [
                            {
                                measure: '优化投流策略，提高转化率',
                                cost: '3000元/月',
                                effect: '营销成本下降20%，ROI提升25%',
                                priority: '高',
                                priorityClass: 'priority-high'
                            },
                            {
                                measure: '建立私域流量，减少依赖平台',
                                cost: '10000元',
                                effect: '长期降低获客成本30%',
                                priority: '中',
                                priorityClass: 'priority-medium'
                            }
                        ]
                    });
                }

                if (kpi.table_turnover < this.thresholds.table_turnover) {
                    report.actionPlans.push({
                        problem: '翻台率偏低',
                        solutions: [
                            {
                                measure: '调整菜品结构，缩短出餐时间',
                                cost: '5000元',
                                effect: '翻台率提升20%，日均客流增加',
                                priority: '高',
                                priorityClass: 'priority-high'
                            },
                            {
                                measure: '引入排队系统，提高座位利用率',
                                cost: '2000元',
                                effect: '座位利用率提升15%',
                                priority: '低',
                                priorityClass: 'priority-low'
                            }
                        ]
                    });
                }

                return report;
            }

            formatValue(key, value) {
                if (value === null || value === undefined || isNaN(value)) return '-';
                
                const percentageKeys = ['food_cost_ratio', 'labor_cost_ratio', 'rent_cost_ratio', 
                                      'marketing_cost_ratio', 'gross_margin', 'takeaway_ratio', 
                                      'member_repurchase', 'energy_cost_ratio', 'negative_comment_rate',
                                      'service_complaint_rate', 'taste_complaint_rate'];
                
                if (percentageKeys.includes(key)) {
                    return (value * 100).toFixed(1) + '%';
                } else if (key === 'review_score') {
                    return value.toFixed(1) + '分';
                } else if (key === 'table_turnover') {
                    return value.toFixed(1) + '次/天';
                } else {
                    return value.toString();
                }
            }

            getInterpretation(key, value) {
                const pct = (value * 100).toFixed(1);
                const num = value.toFixed(1);
                const isNumber = typeof value === 'number' && !isNaN(value);
    
                const interpretations = {
                    food_cost_ratio: `食材成本约占收入的${pct}%。比例偏高可能挤压毛利，可从采购议价、损耗控制、出品标准和菜品定价等环节综合排查；也需结合业态与客单价水平判断。`,
                    labor_cost_ratio: `人工成本约占收入的${pct}%。若长期高于约30%，可评估人效、排班与薪酬结构；淡旺季与营业时段差异也会带来波动，建议结合历史趋势与同类门店对比。`,
                    rent_cost_ratio: `房租约占收入的${pct}%。接近或超过约20%可能带来压力，但商圈溢价、品效、外卖占比与季节性都会影响可承受度，需一并评估。`,
                    marketing_cost_ratio: `营销成本约占收入的${pct}%。若长期高于约10%需关注ROI，可从投流效率、代运营费用、获客成本等维度优化；但新店或拓展期适度提高投入比例属正常现象。`,
                    gross_margin: `每实现100元收入，毛利约为${(isNumber ? (value * 100).toFixed(1) : '—')}元。不同业态目标差异较大，许多快餐/休闲餐饮会把目标放在50-60元区间，仍需结合品类结构与定价策略来看。`,
                    table_turnover: `每张桌子日均接待${num}波客人。快餐/简餐通常希望≥4波，但应与客单价、用餐高峰分布、外卖承载能力与翻台效率一起评估。`,
                    takeaway_ratio: `线上（外卖等）收入占比${pct}%。占比较高可能说明堂食承载有限或线上运营更强，占比较低可能意味着线上仍有优化空间；最终取舍应与品牌定位与利润结构匹配。`,
                    member_repurchase: `会员复购率约${pct}%。数值越高通常意味着粘性更好，但会受活动频次、拉新节奏与门店密度影响；建议结合自然复购与活动复购分拆观察。`,
                    review_score: `团购/平台评分为${isNumber ? value.toFixed(1) : '—'}分。低于4分可能影响转化，应关注口味稳定性、出餐速度与服务体验；亦需留意评分样本量与时间分布。`,
                    negative_comment_rate: `差评率约${pct}%。超过约5%建议跟进原因与样本量，区分偶发问题与系统性问题，并结合具体品类与时段定位整改。`,
                    service_complaint_rate: `服务差评占比约${pct}%。超过约30%说明服务环节存在系统性问题，应从培训体系、服务流程、人员配置等方面系统性改进。`,
                    taste_complaint_rate: `口味差评占比约${pct}%。超过约30%需重点关注出品稳定性、食材品质与厨师技能，这直接影响顾客回头率与口碑传播。`
                };
    
                return interpretations[key] || `当前该指标为${isNumber ? value : '—'}，建议结合历史趋势、同类型门店与所在城市水平综合判断。`;
            }
        }

        // DOM元素引用
        const elements = {
            // 标签页
            dataTab: document.getElementById('dataTab'),
            diagnosisTab: document.getElementById('diagnosisTab'),
            dataContent: document.getElementById('dataContent'),
            diagnosisContent: document.getElementById('diagnosisContent'),
            
            // 数据管理页面
            apiUrl: document.getElementById('apiUrl'),
            adminKey: document.getElementById('adminKey'),
            loadData: document.getElementById('loadData'),
            statusDisplay: document.getElementById('statusDisplay'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            statsSection: document.getElementById('statsSection'),
            paginationSection: document.getElementById('paginationSection'),
            dataContainer: document.getElementById('dataContainer'),
            totalCount: document.getElementById('totalCount'),
            currentCount: document.getElementById('currentCount'),
            latestRecord: document.getElementById('latestRecord'),
            exportCSV: document.getElementById('exportCSV'),
            batchDiagnosis: document.getElementById('batchDiagnosis'),
            limitSelect: document.getElementById('limitSelect'),
            prevPage: document.getElementById('prevPage'),
            nextPage: document.getElementById('nextPage'),
            pageInfo: document.getElementById('pageInfo'),
            
            // 诊断页面
            dataSourceRadios: document.querySelectorAll('input[name="dataSource"]'),
            apiDataSelector: document.getElementById('apiDataSelector'),
            recordSelect: document.getElementById('recordSelect'),
            loadSelectedRecord: document.getElementById('loadSelectedRecord'),
            manualForm: document.getElementById('manualForm'),
            generateReport: document.getElementById('generateReport'),
            reportContainer: document.getElementById('reportContainer'),
            loadingSection: document.getElementById('loadingSection'),
            currentStep: document.getElementById('currentStep'),
            
            // 表单字段
            storeName: document.getElementById('storeName'),
            storeType: document.getElementById('storeType'),
            revenue: document.getElementById('revenue'),
            foodCost: document.getElementById('foodCost'),
            laborCost: document.getElementById('laborCost'),
            rentCost: document.getElementById('rentCost'),
            dailyCustomers: document.getElementById('dailyCustomers'),
            seats: document.getElementById('seats'),
            takeawayRevenue: document.getElementById('takeawayRevenue'),
            marketingCost: document.getElementById('marketingCost'),
            memberRepurchase: document.getElementById('memberRepurchase'),
            totalCustomers: document.getElementById('totalCustomers'),
            energyCost: document.getElementById('energyCost'),
            reviewScore: document.getElementById('reviewScore'),
            negativeComments: document.getElementById('negativeComments'),
            totalComments: document.getElementById('totalComments'),
            socialMentions: document.getElementById('socialMentions'),
            serviceComplaints: document.getElementById('serviceComplaints'),
            tasteComplaints: document.getElementById('tasteComplaints')
        };

        // 初始化诊断系统
        const diagnosis = new RestaurantDiagnosis();

        // 通知功能
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 标签页切换
        function switchTab(tabName) {
            const tabs = ['data', 'diagnosis'];
            const tabButtons = [elements.dataTab, elements.diagnosisTab];
            const tabContents = [elements.dataContent, elements.diagnosisContent];
            
            tabs.forEach((tab, index) => {
                if (tab === tabName) {
                    tabButtons[index].classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
                    tabButtons[index].classList.remove('text-gray-500');
                    tabContents[index].classList.add('active');
                } else {
                    tabButtons[index].classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
                    tabButtons[index].classList.add('text-gray-500');
                    tabContents[index].classList.remove('active');
                }
            });
        }

        // 数据管理功能
        async function loadSurveyData() {
            const api = elements.apiUrl.value.trim();
            const key = elements.adminKey.value.trim();

            if (!api || !key) {
                showNotification('请输入API地址和管理员密钥', 'error');
                return;
            }

            toggleLoading(true);
            showStatus('checking', '正在加载数据...');

            try {
                const offset = (currentPage - 1) * limit;
                const response = await fetch(`${api}/api/surveys?limit=${limit}&offset=${offset}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': key,
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(30000)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentData = data.rows || [];
                    totalRecords = data.total || 0;
                    
                    displayData();
                    updateStats();
                    updatePagination();
                    updateRecordSelect();
                    showStatus('connected', `成功加载 ${currentData.length} 条记录`);
                    showNotification(`成功加载 ${currentData.length} 条记录`);
                    
                    elements.statsSection.classList.remove('hidden');
                    elements.paginationSection.classList.remove('hidden');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                let errorMessage = '加载失败: ';
                
                if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                    errorMessage += '请求超时';
                } else if (error.message.includes('401')) {
                    errorMessage += '管理员密钥错误';
                } else if (error.message.includes('CORS')) {
                    errorMessage += 'CORS错误';
                } else {
                    errorMessage += error.message;
                }
                
                showStatus('error', errorMessage);
                showNotification(errorMessage, 'error');
                elements.dataContainer.innerHTML = `
                    <div class="p-12 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-6xl mb-6"></i>
                        <p class="text-xl">${errorMessage}</p>
                    </div>
                `;
            } finally {
                toggleLoading(false);
            }
        }

        function displayData() {
            if (currentData.length === 0) {
                elements.dataContainer.innerHTML = `
                    <div class="p-12 text-center text-gray-500">
                        <i class="fas fa-inbox text-6xl mb-6"></i>
                        <p class="text-xl">暂无数据</p>
                    </div>
                `;
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table w-full';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>ID</th>
                    <th>提交时间</th>
                    <th>门店名称</th>
                    <th>业态类型</th>
                    <th>月营收</th>
                    <th>食材成本</th>
                    <th>人力成本</th>
                    <th>租金成本</th>
                    <th>日均客流</th>
                    <th>座位数</th>
                    <th>操作</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            currentData.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${formatDate(record.timestamp)}</td>
                    <td>${record.store_name || '-'}</td>
                    <td>${record.business_type || '-'}</td>
                    <td>${formatNumber(record.monthly_revenue)}</td>
                    <td>${formatNumber(record.food_cost)}</td>
                    <td>${formatNumber(record.labor_cost)}</td>
                    <td>${formatNumber(record.rent_cost)}</td>
                    <td>${record.daily_customers || '-'}</td>
                    <td>${record.seats || '-'}</td>
                    <td>
                        <button onclick="viewRecord(${record.id})" class="text-blue-500 hover:text-blue-700 mr-2 p-1" title="查看详情">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="selectForDiagnosis(${record.id})" class="text-green-500 hover:text-green-700 p-1" title="选择诊断">
                            <i class="fas fa-stethoscope"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            elements.dataContainer.innerHTML = '';
            elements.dataContainer.appendChild(table);
        }

        function updateStats() {
            elements.totalCount.textContent = totalRecords.toLocaleString();
            elements.currentCount.textContent = currentData.length;
            
            if (currentData.length > 0) {
                const latest = new Date(currentData[0].timestamp).toLocaleDateString();
                elements.latestRecord.textContent = latest;
            }
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / limit);
            elements.pageInfo.textContent = `页 ${currentPage} / ${totalPages}`;
            
            elements.prevPage.disabled = currentPage <= 1;
            elements.nextPage.disabled = currentPage >= totalPages;
        }

        function updateRecordSelect() {
            elements.recordSelect.innerHTML = '<option value="">请选择一条记录进行诊断</option>';
            currentData.forEach(record => {
                const option = document.createElement('option');
                option.value = record.id;
                option.textContent = `${record.store_name || '未命名'} - ${formatDate(record.timestamp)}`;
                elements.recordSelect.appendChild(option);
            });
        }

        function viewRecord(id) {
            const record = currentData.find(r => r.id === id);
            if (!record) return;

            const details = `
记录ID: ${record.id}
提交时间: ${formatDate(record.timestamp)}

基础信息:
门店名称: ${record.store_name || '-'}
业态类型: ${record.business_type || '-'}
月营收: ${formatNumber(record.monthly_revenue)}
食材成本: ${formatNumber(record.food_cost)}
人力成本: ${formatNumber(record.labor_cost)}
租金成本: ${formatNumber(record.rent_cost)}
日均客流: ${record.daily_customers || '-'}
座位数: ${record.seats || '-'}

运营数据:
线上营收: ${formatNumber(record.online_revenue)}
营销费用: ${formatNumber(record.marketing_cost)}
复购次数: ${record.repeat_purchases || '-'}
总客流: ${record.total_customers || '-'}
水电费: ${formatNumber(record.utility_cost)}

体验数据:
平均评分: ${record.average_rating || '-'}
差评数: ${record.bad_reviews || '-'}
总评论数: ${record.total_reviews || '-'}
社媒提及: ${record.social_media_mentions || '-'}
服务差评率: ${record.service_bad_review_rate || '-'}%
口味差评率: ${record.taste_bad_review_rate || '-'}%

技术信息:
IP地址: ${record.ip || '-'}
用户代理: ${record.user_agent || '-'}
            `;

            alert(details);
        }

        function selectForDiagnosis(id) {
            const record = currentData.find(r => r.id === id);
            if (!record) return;

            // 切换到诊断页面
            switchTab('diagnosis');
            
            // 切换到API数据源
            document.querySelector('input[name="dataSource"][value="api"]').checked = true;
            elements.apiDataSelector.classList.remove('hidden');
            
            // 选中该记录
            elements.recordSelect.value = id;
            selectedRecord = record;
            
            showNotification(`已选择记录: ${record.store_name || '未命名'}`);
        }

        // 下载CSV
        async function downloadCSV() {
            const api = elements.apiUrl.value.trim();
            const key = elements.adminKey.value.trim();

            if (!api || !key) {
                showNotification('请先配置API地址和管理员密钥', 'error');
                return;
            }

            try {
                const response = await fetch(`${api}/api/export`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': key
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `surveys_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showNotification('CSV文件下载成功');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showNotification('导出失败: ' + error.message, 'error');
            }
        }

        // 显示状态
        function showStatus(type, message) {
            elements.statusText.textContent = message;
            elements.statusDisplay.className = 'p-4 rounded-xl mb-6';
            elements.statusIndicator.className = 'w-3 h-3 rounded-full mr-3';

            switch(type) {
                case 'connected':
                    elements.statusDisplay.classList.add('bg-green-100', 'text-green-800');
                    elements.statusIndicator.classList.add('bg-green-500');
                    break;
                case 'checking':
                    elements.statusDisplay.classList.add('bg-yellow-100', 'text-yellow-800');
                    elements.statusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'error':
                    elements.statusDisplay.classList.add('bg-red-100', 'text-red-800');
                    elements.statusIndicator.classList.add('bg-red-500');
                    break;
            }
            elements.statusDisplay.classList.remove('hidden');
        }

        // 切换加载状态
        function toggleLoading(loading) {
            const loadingElement = elements.loadData.querySelector('.loading');
            const textElement = elements.loadData.querySelector('.load-text');
            
            if (loading) {
                loadingElement.classList.add('active');
                textElement.style.display = 'none';
                elements.loadData.disabled = true;
            } else {
                loadingElement.classList.remove('active');
                textElement.style.display = 'flex';
                elements.loadData.disabled = false;
            }
        }

        // 诊断步骤导航
        function showDiagnosisStep(step) {
            // 隐藏所有步骤
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active', 'completed');
                if (parseInt(s.dataset.step) < step) {
                    s.classList.add('completed');
                } else if (parseInt(s.dataset.step) === step) {
                    s.classList.add('active');
                }
            });
            
            // 显示当前步骤
            document.getElementById(`step${step}`).classList.add('active');
            elements.currentStep.textContent = step;
            
            currentDiagnosisStep = step;
        }

        // 验证表单
        function validateDiagnosisStep(step) {
            const stepElement = document.getElementById(`step${step}`);
            const inputs = stepElement.querySelectorAll('input[required], select[required]');
            
            for (let input of inputs) {
                if (!input.value.trim()) {
                    input.focus();
                    showNotification('请填写所有必填项', 'error');
                    return false;
                }
            }
            return true;
        }

        // 收集表单数据
        function collectFormData() {
            return {
                门店名称: elements.storeName.value,
                业态类型: elements.storeType.value,
                营业收入: parseFloat(elements.revenue.value),
                食材成本: parseFloat(elements.foodCost.value),
                人力成本: parseFloat(elements.laborCost.value),
                租金成本: parseFloat(elements.rentCost.value),
                日均客流: parseFloat(elements.dailyCustomers.value),
                座位数: parseFloat(elements.seats.value),
                线上营收: parseFloat(elements.takeawayRevenue.value),
                营销费用: parseFloat(elements.marketingCost.value),
                老客户复购次数: parseFloat(elements.memberRepurchase.value),
                总客流: parseFloat(elements.totalCustomers.value),
                水电气成本: parseFloat(elements.energyCost.value),
                各平台团购均评分: parseFloat(elements.reviewScore.value),
                差评数: parseFloat(elements.negativeComments.value),
                总评论数: parseFloat(elements.totalComments.value),
                社交媒体提及量: parseFloat(elements.socialMentions.value),
                服务差评占比: parseFloat(elements.serviceComplaints.value),
                口味差评占比: parseFloat(elements.tasteComplaints.value)
            };
        }

        // 载入选中记录
        function loadSelectedRecord() {
            const recordId = elements.recordSelect.value;
            if (!recordId) {
                showNotification('请先选择一条记录', 'error');
                return;
            }

            const record = currentData.find(r => r.id == recordId);
            if (!record) {
                showNotification('记录不存在', 'error');
                return;
            }

            // 填充表单数据
            elements.storeName.value = record.store_name || '';
            elements.storeType.value = record.business_type || '';
            elements.revenue.value = record.monthly_revenue || '';
            elements.foodCost.value = record.food_cost || '';
            elements.laborCost.value = record.labor_cost || '';
            elements.rentCost.value = record.rent_cost || '';
            elements.dailyCustomers.value = record.daily_customers || '';
            elements.seats.value = record.seats || '';
            elements.takeawayRevenue.value = record.online_revenue || '';
            elements.marketingCost.value = record.marketing_cost || '';
            elements.memberRepurchase.value = record.repeat_purchases || '';
            elements.totalCustomers.value = record.total_customers || '';
            elements.energyCost.value = record.utility_cost || '';
            elements.reviewScore.value = record.average_rating || '';
            elements.negativeComments.value = record.bad_reviews || '';
            elements.totalComments.value = record.total_reviews || '';
            elements.socialMentions.value = record.social_media_mentions || '';
            elements.serviceComplaints.value = record.service_bad_review_rate || '';
            elements.tasteComplaints.value = record.taste_bad_review_rate || '';

            selectedRecord = record;
            showNotification('记录数据已载入表单');
        }

        // 渲染健康状态表
        function renderHealthTable(healthCheck) {
            const tbody = document.getElementById('healthTableBody');
            tbody.innerHTML = '';
            
            for (const [key, item] of Object.entries(healthCheck)) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.value}</td>
                    <td class="${item.statusClass}">${item.status}</td>
                    <td>${item.interpretation}</td>
                `;
            }
        }

        // 渲染雷达图
        function renderRadarChart(inputData, healthCheck) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const storeType = inputData.业态类型;
            const benchmark = diagnosis.industryBenchmarks[storeType] || diagnosis.industryBenchmarks['其他'];
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['毛利率', '翻台率', '线上占比', '评分表现', '成本控制'],
                    datasets: [{
                        label: '门店表现',
                        data: [
                            healthCheck.gross_margin.rawValue * 100,
                            healthCheck.table_turnover.rawValue,
                            healthCheck.takeaway_ratio.rawValue * 100,
                            healthCheck.review_score.rawValue * 20,
                            100 - (healthCheck.food_cost_ratio.rawValue + healthCheck.labor_cost_ratio.rawValue) * 100
                        ],
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        pointBackgroundColor: 'rgba(52, 152, 219, 1)'
                    }, {
                        label: '行业标杆',
                        data: [
                            benchmark.gross_margin * 100,
                            benchmark.table_turnover,
                            benchmark.takeaway_ratio * 100,
                            80, // 4.0分对应80%
                            75  // 行业平均成本控制水平
                        ],
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        pointBackgroundColor: 'rgba(46, 204, 113, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // 渲染根因分析
        function renderRootCauseAnalysis(rootCauses) {
            const container = document.getElementById('rootCauseAnalysis');
            if (rootCauses.length === 0) {
                container.innerHTML = '<p>恭喜！暂未发现重大经营问题。</p>';
                return;
            }
            
            let html = '';
            rootCauses.forEach((cause, index) => {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 4px; border-left: 4px solid #e74c3c;">
                        <h4>${cause.phenomenon}</h4>
                        <p><strong>可能原因：</strong></p>
                        <ul>
                            ${cause.causes.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                        <p><strong>数据支撑：</strong>${cause.dataSupport}</p>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // 渲染行动计划
        function renderActionPlans(actionPlans) {
            const container = document.getElementById('actionPlans');
            let html = '';
            
            actionPlans.forEach((plan, index) => {
                html += `<h4 style="margin-top: 20px;">${plan.problem}</h4>`;
                plan.solutions.forEach((solution, sIndex) => {
                    html += `
                        <li class="${solution.priorityClass}">
                            <strong>${solution.measure}</strong><br>
                            <small>投入成本：${solution.cost} | 预期效果：${solution.effect} | 优先级：${solution.priority}</small>
                        </li>
                    `;
                });
            });
            
            container.innerHTML = html;
            
            // 关键建议
            document.getElementById('keyRecommendation').innerHTML = `
                <h4>核心建议</h4>
                <p>基于数据分析，建议您优先关注<strong>服务质量提升</strong>和<strong>成本结构优化</strong>。
                通过系统性改进，预计可在3个月内显著改善经营状况。</p>
            `;
        }

        // 生成报告
        function generateReport() {
            const formData = collectFormData();
            const report = diagnosis.diagnose(formData);
            
            // 显示加载动画
            elements.loadingSection.classList.remove('hidden');
            document.getElementById('step3').style.display = 'none';
            
            // 模拟处理时间
            setTimeout(() => {
                elements.loadingSection.classList.add('hidden');
                
                // 渲染各个部分
                renderHealthTable(report.healthCheck);
                renderRadarChart(formData, report.healthCheck);
                renderRootCauseAnalysis(report.rootCauses);
                renderActionPlans(report.actionPlans);
                
                // 显示报告
                elements.reportContainer.classList.remove('hidden');
                
                // 生成下载链接
                generateDownloadLink(formData, report);
                
                showNotification('诊断报告生成成功！');
            }, 3000);
        }

        // 生成下载链接
        function generateDownloadLink(formData, report) {
            const reportHtml = elements.reportContainer.outerHTML;
            const fullHtml = `
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <title>${formData.门店名称} - 诊断报告</title>
                    <style>
                        body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; }
                        .report-section { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
                        .health-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .health-table th, .health-table td { border: 1px solid #ddd; padding: 12px 8px; text-align: left; }
                        .health-table th { background-color: #3498db; color: white; }
                        .status-healthy { background-color: #d4edda !important; color: #155724; }
                        .status-warning { background-color: #fff3cd !important; color: #856404; }
                        .status-danger { background-color: #f8d7da !important; color: #721c24; }
                        .action-plans { list-style: none; padding: 0; }
                        .action-plans li { background: white; margin: 10px 0; padding: 15px; border-left: 4px solid #3498db; border-radius: 4px; }
                        .priority-high { border-left-color: #e74c3c; }
                        .priority-medium { border-left-color: #f39c12; }
                        .priority-low { border-left-color: #2ecc71; }
                    </style>
                </head>
                <body>
                    <h1>${formData.门店名称} - 诊断报告</h1>
                    <p>生成时间：${new Date().toLocaleString()}</p>
                    ${reportHtml}
                </body>
                </html>
            `;
            
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            document.getElementById('downloadLink').href = url;
            document.getElementById('downloadLink').download = `${formData.门店名称}_诊断报告_${new Date().toISOString().split('T')[0]}.html`;
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('zh-CN');
        }

        // 格式化数字
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString();
        }

        // 事件监听器
        elements.dataTab.addEventListener('click', () => switchTab('data'));
        elements.diagnosisTab.addEventListener('click', () => switchTab('diagnosis'));
        elements.loadData.addEventListener('click', loadSurveyData);
        elements.exportCSV.addEventListener('click', downloadCSV);
        elements.limitSelect.addEventListener('change', (e) => {
            limit = parseInt(e.target.value);
            currentPage = 1;
            loadSurveyData();
        });
        elements.prevPage.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadSurveyData();
            }
        });
        elements.nextPage.addEventListener('click', () => {
            currentPage++;
            loadSurveyData();
        });

        // 诊断页面事件监听
        elements.dataSourceRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'api') {
                    elements.apiDataSelector.classList.remove('hidden');
                } else {
                    elements.apiDataSelector.classList.add('hidden');
                }
            });
        });

        elements.loadSelectedRecord.addEventListener('click', loadSelectedRecord);

        // 分步表单导航
        document.getElementById('nextBtn1').addEventListener('click', () => {
            if (validateDiagnosisStep(1)) {
                showDiagnosisStep(2);
            }
        });

        document.getElementById('prevBtn2').addEventListener('click', () => {
            showDiagnosisStep(1);
        });

        document.getElementById('nextBtn2').addEventListener('click', () => {
            if (validateDiagnosisStep(2)) {
                showDiagnosisStep(3);
            }
        });

        document.getElementById('prevBtn3').addEventListener('click', () => {
            showDiagnosisStep(2);
        });

        elements.generateReport.addEventListener('click', () => {
            if (validateDiagnosisStep(3)) {
                generateReport();
            }
        });

        // 初始化
        showDiagnosisStep(1);
    </script>
</body>
</html>
