<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤é¥®è°ƒæŸ¥æ•°æ®ç®¡ç†ä¸è¯Šæ–­ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-flex;
            align-items: center;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-table {
            font-size: 13px;
        }
        .data-table th,
        .data-table td {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .data-table tr:hover {
            background-color: #f0f9ff;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .health-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .health-table th, .health-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .health-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        .status-healthy {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: 600;
        }
        .status-warning {
            background-color: #fff3cd !important;
            color: #856404;
            font-weight: 600;
        }
        .status-danger {
            background-color: #f8d7da !important;
            color: #721c24;
            font-weight: 600;
        }
        .diagnosis-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .diagnosis-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
        }
        .diagnosis-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 10px;
        }
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 12px 0;
            border-left: 4px solid #667eea;
        }
        .action-plans {
            list-style: none;
            padding: 0;
        }
        .action-plans li {
            background: white;
            margin: 12px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .priority-high { border-left-color: #e74c3c; }
        .priority-medium { border-left-color: #f39c12; }
        .priority-low { border-left-color: #2ecc71; }
        .store-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 15px 0;
        }
        .store-info-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        .store-info-item label {
            font-size: 11px;
            color: #7f8c8d;
            display: block;
            margin-bottom: 4px;
        }
        .store-info-item value {
            font-size: 15px;
            color: #2c3e50;
            font-weight: 600;
        }
        .score-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        .score-excellent { background: #d4edda; color: #155724; }
        .score-good { background: #d1ecf1; color: #0c5460; }
        .score-average { background: #fff3cd; color: #856404; }
        .score-poor { background: #f8d7da; color: #721c24; }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-top: 3px solid #667eea;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        #reportExport {
            background: white;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }
        .report-header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- æ ‡é¢˜å’Œé…ç½® -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">é¤é¥®è°ƒæŸ¥æ•°æ®ç®¡ç†ä¸è¯Šæ–­ç³»ç»Ÿ</h1>
            
            <!-- API é…ç½® -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-gray-700 mb-2">API åœ°å€</label>
                    <input type="url" id="apiUrl" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           value="https://restaurant-survey-backend-postgres.onrender.com">
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">ç®¡ç†å‘˜å¯†é’¥</label>
                    <input type="password" id="adminKey" 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="è¯·è¾“å…¥ADMIN_KEY">
                </div>
                <div class="flex items-end">
                    <button id="loadData" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        <div class="loading">
                            <div class="spinner"></div>
                            åŠ è½½ä¸­...
                        </div>
                        <span class="load-text">
                            <i class="fas fa-sync mr-2"></i>åŠ è½½æ•°æ®
                        </span>
                    </button>
                </div>
            </div>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div id="statusDisplay" class="p-3 rounded-lg mb-4 hidden">
                <div class="flex items-center">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full mr-2"></div>
                    <span id="statusText"></span>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div id="statsSection" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-blue-600 text-sm font-medium">æ€»è®°å½•æ•°</div>
                        <div id="totalCount" class="text-2xl font-bold text-blue-800">0</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-green-600 text-sm font-medium">å½“å‰æ˜¾ç¤º</div>
                        <div id="currentCount" class="text-2xl font-bold text-green-800">0</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-purple-600 text-sm font-medium">æœ€æ–°è®°å½•</div>
                        <div id="latestRecord" class="text-sm font-medium text-purple-800">-</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-orange-600 text-sm font-medium">æ“ä½œ</div>
                        <button id="exportCSV" class="text-sm bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600">
                            <i class="fas fa-download mr-1"></i>å¯¼å‡ºCSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- åˆ†é¡µæ§åˆ¶ -->
            <div id="paginationSection" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-700">æ¯é¡µæ˜¾ç¤º:</label>
                        <select id="limitSelect" class="px-3 py-1 border rounded">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prevPage" class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                        </button>
                        <span id="pageInfo" class="text-gray-600">é¡µ 1</span>
                        <button id="nextPage" class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50">
                            ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">è°ƒæŸ¥æ•°æ®</h2>
            </div>
            <div class="overflow-x-auto">
                <div id="dataContainer" class="p-8 text-center text-gray-500">
                    <i class="fas fa-database text-4xl mb-4"></i>
                    <p>è¯·å…ˆé…ç½®APIåœ°å€å’Œç®¡ç†å‘˜å¯†é’¥,ç„¶åç‚¹å‡»"åŠ è½½æ•°æ®"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…/è¯Šæ–­å¼¹çª— -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                        <span id="modalTitle">è¯¦ç»†ä¿¡æ¯</span>
                    </h2>
                    <div class="flex space-x-2">
                        <button id="exportImageBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 hidden">
                            <i class="fas fa-image mr-2"></i>ä¿å­˜é•¿å›¾
                        </button>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <div class="border-b mb-6">
                    <button class="tab-button active" data-tab="details">
                        <i class="fas fa-info-circle mr-2"></i>æ•°æ®è¯¦æƒ…
                    </button>
                    <button class="tab-button" data-tab="diagnosis">
                        <i class="fas fa-stethoscope mr-2"></i>AIè¯Šæ–­æŠ¥å‘Š
                    </button>
                </div>

                <!-- æ•°æ®è¯¦æƒ…æ ‡ç­¾ -->
                <div id="detailsTab" class="tab-content active">
                    <div id="modalContent" class="space-y-6"></div>
                </div>

                <!-- AIè¯Šæ–­æ ‡ç­¾ -->
                <div id="diagnosisTab" class="tab-content">
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600; color: #374151;">ä¸»é¢˜é€‰æ‹©ï¼š</label>
                            <select id="themeSelector" onchange="changeTheme(this.value)" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
                                <option value="fresh">ğŸŒ¿ æ¸…æ–°ä¸»é¢˜</option>
                                <option value="professional">âš™ï¸ ä¸“ä¸šä¸»é¢˜</option>
                                <option value="business">ğŸ’¼ å•†åŠ¡ä¸»é¢˜</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="exportToPDF()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                ğŸ“„ å¯¼å‡ºPDF
                            </button>
                            <button onclick="exportToImage()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                ğŸ–¼ï¸ å¯¼å‡ºå›¾ç‰‡
                            </button>
                        </div>
                    </div>
                    <div id="reportExport">
                        <div id="diagnosisContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentPage = 1;
        let totalRecords = 0;
        let limit = 25;
        let currentRecord = null;

        const apiUrl = document.getElementById('apiUrl');
        const adminKey = document.getElementById('adminKey');
        const loadData = document.getElementById('loadData');
        const statusDisplay = document.getElementById('statusDisplay');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const statsSection = document.getElementById('statsSection');
        const paginationSection = document.getElementById('paginationSection');
        const dataContainer = document.getElementById('dataContainer');
        const totalCount = document.getElementById('totalCount');
        const currentCount = document.getElementById('currentCount');
        const latestRecord = document.getElementById('latestRecord');
        const exportCSV = document.getElementById('exportCSV');
        const limitSelect = document.getElementById('limitSelect');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const detailModal = document.getElementById('detailModal');
        const closeModal = document.getElementById('closeModal');
        const exportImageBtn = document.getElementById('exportImageBtn');

        // å‡çº§ç‰ˆè¯Šæ–­ç³»ç»Ÿç±»
        class RestaurantDiagnosisAdvanced {
            constructor() {
                this.thresholds = {
                    // åŸºç¡€æˆæœ¬æŒ‡æ ‡
                    food_cost_ratio: 0.35,
                    labor_cost_ratio: 0.30,
                    rent_cost_ratio: 0.20,
                    marketing_cost_ratio: 0.10,
                    utility_cost_ratio: 0.05,
                    gross_margin: 0.55,
                    
                    // æ•ˆç‡æŒ‡æ ‡
                    table_turnover: 3.0,
                    revenue_per_sqm: 5000,  // åªæ•ˆ: å…ƒ/å¹³ç±³/æœˆ
                    revenue_per_employee: 30000,  // äººæ•ˆ: å…ƒ/äºº/æœˆ
                    
                    // å®¢æˆ·æŒ‡æ ‡
                    avg_spending: 50,  // å®¢å•ä»·
                    member_repurchase: 0.25,
                    
                    // çº¿ä¸ŠæŒ‡æ ‡
                    takeaway_ratio: [0.3, 0.5],
                    review_score: 4.0,
                    negative_comment_rate: 0.05,
                    
                    // å†…å®¹è¥é”€æŒ‡æ ‡
                    content_marketing_index: 60,  // ç»¼åˆè¯„åˆ†
                    short_video_count: 50,
                    live_stream_count: 15,
                    
                    // å·®è¯„ç»†åˆ†
                    service_bad_review_rate: 0.30,
                    taste_bad_review_rate: 0.30
                };

                this.industryBenchmarks = {
                    'å¿«é¤': { table_turnover: 4.5, gross_margin: 0.60, takeaway_ratio: 0.4, revenue_per_sqm: 6000, avg_spending: 35 },
                    'ç«é”…': { table_turnover: 3.5, gross_margin: 0.65, takeaway_ratio: 0.3, revenue_per_sqm: 7000, avg_spending: 80 },
                    'æ­£é¤': { table_turnover: 2.5, gross_margin: 0.58, takeaway_ratio: 0.25, revenue_per_sqm: 5500, avg_spending: 70 },
                    'èŒ¶é¤å…': { table_turnover: 3.0, gross_margin: 0.55, takeaway_ratio: 0.3, revenue_per_sqm: 5000, avg_spending: 45 },
                    'å’–å•¡å…': { table_turnover: 2.0, gross_margin: 0.70, takeaway_ratio: 0.4, revenue_per_sqm: 4500, avg_spending: 40 },
                    'èŒ¶é¥®åº—': { table_turnover: 5.0, gross_margin: 0.65, takeaway_ratio: 0.6, revenue_per_sqm: 8000, avg_spending: 25 },
                    'å…¶ä»–': { table_turnover: 3.0, gross_margin: 0.55, takeaway_ratio: 0.3, revenue_per_sqm: 5000, avg_spending: 50 }
                };

                // å•†åœˆç­‰çº§è¯„åˆ†
                this.businessCircleScores = {
                    'ä¸€ç±»å•†åœºé‡Œé¢': 95,
                    'äºŒç±»å•†åœºé‡Œé¢': 85,
                    'ä¸€ç±»å•†åœˆ': 90,
                    'äºŒç±»å•†åœˆ': 80,
                    'ä¸€ç±»ä¸»è¡—': 85,
                    'äºŒç±»ä¸»è¡—': 75,
                    'ä¸€ç±»ç¤¾åŒº': 70,
                    'äºŒç±»ç¤¾åŒº': 60
                };

                // è£…ä¿®æ¡£æ¬¡è¯„åˆ†
                this.decorationScores = {
                    'ä¸­é«˜æ¡£': 90,
                    'ä¸­æ¡£': 75,
                    'ä¸­ä½æ¡£': 60
                };
            }

            calculateKPI(data) {
                const totalCost = (data.food_cost || 0) + (data.labor_cost || 0) + (data.rent_cost || 0) + 
                                (data.marketing_cost || 0) + (data.utility_cost || 0);
                
                // è®¡ç®—å‘˜å·¥æ•°(æ ¹æ®äººåŠ›æˆæœ¬å’Œè¡Œä¸šå¹³å‡å·¥èµ„ä¼°ç®—)
                const estimatedEmployees = Math.max(1, Math.round((data.labor_cost || 0) / 5000));
                
                return {
                    // åŸºç¡€æˆæœ¬ç‡
                    food_cost_ratio: (data.food_cost || 0) / (data.monthly_revenue || 1),
                    labor_cost_ratio: (data.labor_cost || 0) / (data.monthly_revenue || 1),
                    rent_cost_ratio: (data.rent_cost || 0) / (data.monthly_revenue || 1),
                    marketing_cost_ratio: (data.marketing_cost || 0) / (data.monthly_revenue || 1),
                    utility_cost_ratio: (data.utility_cost || 0) / (data.monthly_revenue || 1),
                    gross_margin: 1 - (totalCost / (data.monthly_revenue || 1)),
                    
                    // æ•ˆç‡æŒ‡æ ‡
                    table_turnover: (data.daily_customers || 0) / (data.seats || 1),
                    revenue_per_sqm: (data.monthly_revenue || 0) / (data.store_area || 1),  // åªæ•ˆ
                    revenue_per_employee: (data.monthly_revenue || 0) / estimatedEmployees,  // äººæ•ˆ
                    
                    // å®¢æˆ·æŒ‡æ ‡
                    avg_spending: (data.monthly_revenue || 0) / (data.total_customers || 1),  // å®¢å•ä»·
                    member_repurchase: (data.repeat_customers || 0) / (data.total_customers || 1),
                    
                    // çº¿ä¸ŠæŒ‡æ ‡
                    takeaway_ratio: (data.online_revenue || 0) / (data.monthly_revenue || 1),
                    review_score: data.average_rating || 0,
                    negative_comment_rate: (data.bad_reviews || 0) / (data.total_reviews || 1),
                    
                    // å†…å®¹è¥é”€æŒ‡æ•°(ç»¼åˆè¯„åˆ†)
                    content_marketing_index: this.calculateContentMarketingIndex(data),
                    short_video_count: data.short_video_count || 0,
                    live_stream_count: data.live_stream_count || 0,
                    
                    // å·®è¯„åˆ†æ
                    service_bad_review_rate: (data.service_bad_reviews || 0) / (data.bad_reviews || 1),
                    taste_bad_review_rate: (data.taste_bad_reviews || 0) / (data.bad_reviews || 1),
                    
                    // é€‰å€åŒ¹é…åº¦
                    location_match_score: this.calculateLocationMatchScore(data),
                    
                    // è¥é”€å¥åº·åº¦
                    marketing_health_score: this.calculateMarketingHealthScore(data),
                    
                    // è¾…åŠ©æ•°æ®
                    estimated_employees: estimatedEmployees
                };
            }

            // è®¡ç®—å†…å®¹è¥é”€æŒ‡æ•°
            calculateContentMarketingIndex(data) {
                let score = 0;
                
                // çŸ­è§†é¢‘å‘å¸ƒé‡å¾—åˆ† (0-40åˆ†)
                const videoScore = Math.min(40, (data.short_video_count || 0) / 100 * 40);
                score += videoScore;
                
                // ç›´æ’­åœºæ¬¡å¾—åˆ† (0-30åˆ†)
                const liveScore = Math.min(30, (data.live_stream_count || 0) / 30 * 30);
                score += liveScore;
                
                // è¥é”€æƒ…å†µå¾—åˆ† (0-30åˆ†)
                const marketingSituationScore = {
                    'æœ‰è‡ªå·±å›¢é˜Ÿ': 30,
                    'æ‰¾ä»£è¿è¥': 25,
                    'è€æ¿è¿è¥': 20,
                    'æ— ': 0
                };
                score += marketingSituationScore[data.marketing_situation] || 15;
                
                return Math.round(score);
            }

            // è®¡ç®—é€‰å€åŒ¹é…åº¦è¯„åˆ†
            calculateLocationMatchScore(data) {
                let score = 0;
                
                // å•†åœˆå¾—åˆ† (0-40åˆ†)
                const circleScore = (this.businessCircleScores[data.business_circle] || 70) / 100 * 40;
                score += circleScore;
                
                // è£…ä¿®æ¡£æ¬¡å¾—åˆ† (0-30åˆ†)
                const decorScore = (this.decorationScores[data.decoration_level] || 70) / 100 * 30;
                score += decorScore;
                
                // ä¸šæ€åŒ¹é…å¾—åˆ† (0-30åˆ†) - åŸºäºåªæ•ˆå’Œå®¢å•ä»·
                const benchmark = this.industryBenchmarks[data.business_type] || this.industryBenchmarks['å…¶ä»–'];
                const revenuePerSqm = (data.monthly_revenue || 0) / (data.store_area || 1);
                const matchScore = Math.min(30, (revenuePerSqm / benchmark.revenue_per_sqm) * 30);
                score += matchScore;
                
                return Math.round(score);
            }

            // è®¡ç®—è¥é”€å¥åº·åº¦
            calculateMarketingHealthScore(data) {
                let score = 0;
                
                // ROIå¾—åˆ† (0-40åˆ†) - è¥é”€æˆæœ¬å æ¯”è¶Šä½è¶Šå¥½
                const marketingRatio = (data.marketing_cost || 0) / (data.monthly_revenue || 1);
                const roiScore = Math.max(0, 40 - (marketingRatio * 100 * 4));
                score += roiScore;
                
                // çº¿ä¸Šè¡¨ç°å¾—åˆ† (0-30åˆ†)
                const onlineScore = Math.min(30, ((data.average_rating || 0) / 5) * 30);
                score += onlineScore;
                
                // å†…å®¹è¥é”€å¾—åˆ† (0-30åˆ†)
                const contentScore = this.calculateContentMarketingIndex(data) / 100 * 30;
                score += contentScore;
                
                return Math.round(score);
            }

            diagnose(data) {
                const kpi = this.calculateKPI(data);
                const report = { 
                    healthCheck: {}, 
                    rootCauses: [], 
                    actionPlans: [],
                    overallScore: 0,
                    dimensionScores: {}
                };

                // æ ¸å¿ƒæŒ‡æ ‡å¥åº·æ£€æŸ¥
                const indicators = {
                    'food_cost_ratio': 'é£Ÿææˆæœ¬ç‡',
                    'labor_cost_ratio': 'äººåŠ›æˆæœ¬ç‡',
                    'rent_cost_ratio': 'ç§Ÿé‡‘æˆæœ¬ç‡',
                    'marketing_cost_ratio': 'è¥é”€æˆæœ¬ç‡',
                    'utility_cost_ratio': 'æ°´ç”µæ°”æˆæœ¬ç‡',
                    'gross_margin': 'æ¯›åˆ©ç‡',
                    'table_turnover': 'ç¿»å°ç‡',
                    'revenue_per_sqm': 'åªæ•ˆ',
                    'revenue_per_employee': 'äººæ•ˆ',
                    'avg_spending': 'å®¢å•ä»·',
                    'member_repurchase': 'ä¼šå‘˜å¤è´­ç‡',
                    'takeaway_ratio': 'çº¿ä¸Šå æ¯”',
                    'review_score': 'å›¢è´­è¯„åˆ†',
                    'negative_comment_rate': 'å·®è¯„ç‡',
                    'content_marketing_index': 'å†…å®¹è¥é”€æŒ‡æ•°',
                    'location_match_score': 'é€‰å€åŒ¹é…åº¦',
                    'marketing_health_score': 'è¥é”€å¥åº·åº¦'
                };

                for (const [key, name] of Object.entries(indicators)) {
                    const value = kpi[key];
                    const threshold = this.thresholds[key];
                    let status = 'å¥åº·', statusClass = 'status-healthy';

                    // è¯„åˆ†ç±»æŒ‡æ ‡
                    if (key.includes('score') || key.includes('index')) {
                        if (value >= 80) {
                            status = 'ä¼˜ç§€';
                            statusClass = 'status-healthy';
                        } else if (value >= 60) {
                            status = 'è‰¯å¥½';
                            statusClass = 'status-healthy';
                        } else if (value >= 40) {
                            status = 'å¾…æ”¹è¿›';
                            statusClass = 'status-warning';
                        } else {
                            status = 'è¾ƒå·®';
                            statusClass = 'status-danger';
                        }
                    }
                    // æ¯”ç‡ç±»æŒ‡æ ‡
                    else if (Array.isArray(threshold)) {
                        if (value < threshold[0] || value > threshold[1]) {
                            status = 'å¼‚å¸¸';
                            statusClass = 'status-danger';
                        }
                    } else {
                        const isPositive = ['gross_margin', 'review_score', 'member_repurchase', 
                                          'revenue_per_sqm', 'revenue_per_employee', 'avg_spending'].includes(key);
                        
                        if (isPositive && value < threshold) {
                            status = 'åä½';
                            statusClass = 'status-warning';
                        } else if (!isPositive && value > threshold) {
                            status = 'åé«˜';
                            statusClass = 'status-danger';
                        }
                    }

                    report.healthCheck[key] = {
                        name,
                        value: this.formatValue(key, value),
                        rawValue: value,
                        status,
                        statusClass,
                        interpretation: this.getInterpretation(key, value, data)
                    };
                }

                // ç»´åº¦è¯„åˆ†
                report.dimensionScores = {
                    cost: this.calculateCostScore(kpi),
                    efficiency: this.calculateEfficiencyScore(kpi),
                    customer: this.calculateCustomerScore(kpi),
                    marketing: kpi.marketing_health_score,
                    location: kpi.location_match_score
                };

                // æ€»ä½“è¯„åˆ†
                report.overallScore = Math.round(
                    (report.dimensionScores.cost + 
                     report.dimensionScores.efficiency + 
                     report.dimensionScores.customer + 
                     report.dimensionScores.marketing + 
                     report.dimensionScores.location) / 5
                );

                // æ ¹å› åˆ†æ
                this.analyzeRootCauses(kpi, data, report);

                // è¡ŒåŠ¨å»ºè®®
                this.generateActionPlans(kpi, data, report);

                return report;
            }

            calculateCostScore(kpi) {
                let score = 100;
                if (kpi.food_cost_ratio > 0.40) score -= 20;
                else if (kpi.food_cost_ratio > 0.35) score -= 10;
                
                if (kpi.labor_cost_ratio > 0.35) score -= 20;
                else if (kpi.labor_cost_ratio > 0.30) score -= 10;
                
                if (kpi.rent_cost_ratio > 0.25) score -= 20;
                else if (kpi.rent_cost_ratio > 0.20) score -= 10;
                
                return Math.max(0, score);
            }

            calculateEfficiencyScore(kpi) {
                let score = 0;
                
                // ç¿»å°ç‡å¾—åˆ†
                if (kpi.table_turnover >= 4) score += 35;
                else if (kpi.table_turnover >= 3) score += 25;
                else score += 15;
                
                // åªæ•ˆå¾—åˆ†
                if (kpi.revenue_per_sqm >= 6000) score += 35;
                else if (kpi.revenue_per_sqm >= 4000) score += 25;
                else score += 15;
                
                // äººæ•ˆå¾—åˆ†
                if (kpi.revenue_per_employee >= 35000) score += 30;
                else if (kpi.revenue_per_employee >= 25000) score += 20;
                else score += 10;
                
                return score;
            }

            calculateCustomerScore(kpi) {
                let score = 0;
                
                // è¯„åˆ†
                score += (kpi.review_score / 5) * 40;
                
                // å¤è´­ç‡
                score += Math.min(30, kpi.member_repurchase * 100);
                
                // å·®è¯„ç‡
                if (kpi.negative_comment_rate < 0.03) score += 30;
                else if (kpi.negative_comment_rate < 0.05) score += 20;
                else score += 10;
                
                return Math.round(score);
            }

            analyzeRootCauses(kpi, data, report) {
                // æˆæœ¬é—®é¢˜
                if (kpi.food_cost_ratio > 0.35) {
                    report.rootCauses.push({
                        phenomenon: 'é£Ÿææˆæœ¬ç‡è¿‡é«˜',
                        causes: [
                            'é‡‡è´­è®®ä»·èƒ½åŠ›ä¸è¶³',
                            'é£ŸææŸè€—ç‡é«˜',
                            'å‡ºå“ä»½é‡æ ‡å‡†ä¸ç»Ÿä¸€',
                            'èœå“å®šä»·åä½'
                        ],
                        dataSupport: `é£Ÿææˆæœ¬å æ¯”${(kpi.food_cost_ratio * 100).toFixed(1)}%,å»ºè®®æ§åˆ¶åœ¨35%ä»¥å†…`
                    });
                }

                // æ•ˆç‡é—®é¢˜
                if (kpi.revenue_per_sqm < 4000) {
                    report.rootCauses.push({
                        phenomenon: 'åªæ•ˆåä½',
                        causes: [
                            'ç©ºé—´åˆ©ç”¨ç‡ä¸è¶³',
                            'å®¢æµé‡ä¸è¶³',
                            'å®¢å•ä»·åä½',
                            'è¥ä¸šæ—¶é—´åˆ©ç”¨ä¸å……åˆ†'
                        ],
                        dataSupport: `å½“å‰åªæ•ˆ${kpi.revenue_per_sqm.toFixed(0)}å…ƒ/ã¡/æœˆ,è¡Œä¸šå¹³å‡çº¦5000å…ƒ`
                    });
                }

                // å®¢æˆ·ä½“éªŒé—®é¢˜
                if (kpi.negative_comment_rate > 0.05) {
                    report.rootCauses.push({
                        phenomenon: 'å·®è¯„ç‡è¿‡é«˜',
                        causes: [
                            `æœåŠ¡é—®é¢˜å å·®è¯„${(kpi.service_bad_review_rate * 100).toFixed(1)}%`,
                            `å£å‘³é—®é¢˜å å·®è¯„${(kpi.taste_bad_review_rate * 100).toFixed(1)}%`
                        ],
                        dataSupport: `å·®è¯„ç‡${(kpi.negative_comment_rate * 100).toFixed(1)}%,éœ€æ§åˆ¶åœ¨5%ä»¥å†…`
                    });
                }

                // è¥é”€é—®é¢˜
                if (kpi.content_marketing_index < 50) {
                    report.rootCauses.push({
                        phenomenon: 'å†…å®¹è¥é”€ä¸è¶³',
                        causes: [
                            `çŸ­è§†é¢‘æœˆå‘å¸ƒé‡ä»…${kpi.short_video_count}æ¡`,
                            `ç›´æ’­åœºæ¬¡ä»…${kpi.live_stream_count}æ¬¡`,
                            'ç¼ºä¹ç³»ç»ŸåŒ–çš„å†…å®¹è¿è¥'
                        ],
                        dataSupport: `å†…å®¹è¥é”€æŒ‡æ•°${kpi.content_marketing_index}åˆ†,å»ºè®®è‡³å°‘è¾¾åˆ°60åˆ†`
                    });
                }
            }

            generateActionPlans(kpi, data, report) {
                // æˆæœ¬ä¼˜åŒ–
                if (kpi.food_cost_ratio > 0.35) {
                    report.actionPlans.push({
                        problem: 'é£Ÿææˆæœ¬ç‡è¿‡é«˜',
                        priority: 'é«˜',
                        solutions: [{
                            measure: 'å»ºç«‹æ ‡å‡†åŒ–å‡ºå“æµç¨‹,æ§åˆ¶é£ŸææŸè€—',
                            cost: '5000å…ƒ(åŸ¹è®­+è®¾å¤‡)',
                            effect: 'é¢„è®¡é™ä½é£Ÿææˆæœ¬ç‡3-5%,æœˆèŠ‚çœ' + Math.round(data.monthly_revenue * 0.04) + 'å…ƒ',
                            timeline: '1ä¸ªæœˆè§æ•ˆ',
                            priorityClass: 'priority-high'
                        }]
                    });
                }

                // æ•ˆç‡æå‡
                if (kpi.revenue_per_sqm < 4000) {
                    report.actionPlans.push({
                        problem: 'åªæ•ˆåä½',
                        priority: 'é«˜',
                        solutions: [{
                            measure: 'ä¼˜åŒ–åº§ä½å¸ƒå±€,å¢åŠ é«˜å³°æœŸç¿»å°ç‡',
                            cost: '8000å…ƒ(å¸ƒå±€è°ƒæ•´)',
                            effect: 'é¢„è®¡æå‡åªæ•ˆ20%,æœˆå¢æ”¶' + Math.round(data.monthly_revenue * 0.2) + 'å…ƒ',
                            timeline: '2å‘¨è§æ•ˆ',
                            priorityClass: 'priority-high'
                        }]
                    });
                }

                // å†…å®¹è¥é”€
                if (kpi.content_marketing_index < 60) {
                    report.actionPlans.push({
                        problem: 'å†…å®¹è¥é”€æŠ•å…¥ä¸è¶³',
                        priority: 'ä¸­',
                        solutions: [{
                            measure: 'å»ºç«‹çŸ­è§†é¢‘å’Œç›´æ’­å†…å®¹æ—¥å†,æå‡å‘å¸ƒé¢‘ç‡',
                            cost: '3000å…ƒ/æœˆ(å†…å®¹åˆ¶ä½œ)',
                            effect: 'é¢„è®¡æå‡çº¿ä¸Šæ›å…‰åº¦50%,å¸¦æ¥10-15%æ–°å®¢',
                            timeline: '2-3ä¸ªæœˆè§æ•ˆ',
                            priorityClass: 'priority-medium'
                        }]
                    });
                }

                // å®¢æˆ·ä½“éªŒ
                if (kpi.service_bad_review_rate > 0.3) {
                    report.actionPlans.push({
                        problem: 'æœåŠ¡å·®è¯„å æ¯”é«˜',
                        priority: 'é«˜',
                        solutions: [{
                            measure: 'å»ºç«‹æœåŠ¡SOPæ ‡å‡†,å¼ºåŒ–å‘˜å·¥åŸ¹è®­',
                            cost: '4000å…ƒ/æœˆ',
                            effect: 'é¢„è®¡é™ä½æœåŠ¡å·®è¯„50%,æ•´ä½“è¯„åˆ†æå‡0.3åˆ†',
                            timeline: '1ä¸ªæœˆè§æ•ˆ',
                            priorityClass: 'priority-high'
                        }]
                    });
                }
            }

            formatValue(key, value) {
                if (key.includes('score') || key.includes('index')) {
                    return Math.round(value) + 'åˆ†';
                }
                if (key === 'revenue_per_sqm') {
                    return 'Â¥' + Math.round(value) + '/ã¡';
                }
                if (key === 'revenue_per_employee') {
                    return 'Â¥' + Math.round(value);
                }
                if (key === 'avg_spending') {
                    return 'Â¥' + Math.round(value);
                }
                if (key === 'short_video_count' || key === 'live_stream_count') {
                    return Math.round(value) + 'æ¡/æœˆ';
                }
                if (key === 'review_score') {
                    return value.toFixed(1) + 'åˆ†';
                }
                if (key === 'table_turnover') {
                    return value.toFixed(1) + 'æ¬¡/å¤©';
                }
                return (value * 100).toFixed(1) + '%';
            }

            getInterpretation(key, value, data) {
                const interpretations = {
                    revenue_per_sqm: `æ¯å¹³ç±³æœˆäº§å‡º${Math.round(value)}å…ƒã€‚è¡Œä¸šä¼˜ç§€æ°´å¹³ä¸º6000å…ƒ/ã¡ä»¥ä¸Š`,
                    revenue_per_employee: `äººå‡æœˆäº§å€¼${Math.round(value)}å…ƒã€‚å»ºè®®è¾¾åˆ°3ä¸‡å…ƒä»¥ä¸Š`,
                    avg_spending: `å¹³å‡å®¢å•ä»·${Math.round(value)}å…ƒã€‚éœ€ç»“åˆä¸šæ€å®šä½è¯„ä¼°`,
                    content_marketing_index: `å†…å®¹è¥é”€ç»¼åˆå¾—åˆ†${Math.round(value)}åˆ†(æ»¡åˆ†100)ã€‚åŒ…å«çŸ­è§†é¢‘ã€ç›´æ’­åŠè¿è¥å›¢é˜Ÿè¯„ä¼°`,
                    location_match_score: `é€‰å€åŒ¹é…åº¦${Math.round(value)}åˆ†ã€‚ç»¼åˆå•†åœˆã€è£…ä¿®æ¡£æ¬¡ä¸ä¸šæ€çš„å¥‘åˆåº¦`,
                    marketing_health_score: `è¥é”€å¥åº·åº¦${Math.round(value)}åˆ†ã€‚ç»¼åˆROIã€çº¿ä¸Šè¡¨ç°ä¸å†…å®¹è¥é”€èƒ½åŠ›`
                };
                
                if (interpretations[key]) return interpretations[key];
                
                const pct = (value * 100).toFixed(1);
                const basicInterpretations = {
                    food_cost_ratio: `é£Ÿææˆæœ¬å è¥æ”¶${pct}%`,
                    labor_cost_ratio: `äººåŠ›æˆæœ¬å è¥æ”¶${pct}%`,
                    rent_cost_ratio: `ç§Ÿé‡‘å è¥æ”¶${pct}%`,
                    marketing_cost_ratio: `è¥é”€æˆæœ¬å è¥æ”¶${pct}%`,
                    utility_cost_ratio: `æ°´ç”µæ°”å è¥æ”¶${pct}%`,
                    gross_margin: `æ¯›åˆ©ç‡${pct}%`,
                    table_turnover: `æ—¥å‡ç¿»å°${value.toFixed(1)}æ¬¡`,
                    takeaway_ratio: `çº¿ä¸Šè¥æ”¶å æ¯”${pct}%`,
                    member_repurchase: `ä¼šå‘˜å¤è´­ç‡${pct}%`,
                    review_score: `å¹³å°è¯„åˆ†${value.toFixed(1)}åˆ†`,
                    negative_comment_rate: `å·®è¯„ç‡${pct}%`
                };
                
                return basicInterpretations[key] || '';
            }

            getScoreBadgeClass(score) {
                if (score >= 80) return 'score-excellent';
                if (score >= 60) return 'score-good';
                if (score >= 40) return 'score-average';
                return 'score-poor';
            }

            getScoreLabel(score) {
                if (score >= 80) return 'ä¼˜ç§€';
                if (score >= 60) return 'è‰¯å¥½';
                if (score >= 40) return 'åŠæ ¼';
                return 'è¾ƒå·®';
            }
        }

        const diagnosis = new RestaurantDiagnosisAdvanced();

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(tab + 'Tab').classList.add('active');
                
                // æ˜¾ç¤º/éšè—å¯¼å‡ºæŒ‰é’®
                exportImageBtn.classList.toggle('hidden', tab !== 'diagnosis');
            });
        });

        // å¯¼å‡ºé•¿å›¾
        exportImageBtn.addEventListener('click', async () => {
            const element = document.getElementById('reportExport');
            exportImageBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ç”Ÿæˆä¸­...';
            exportImageBtn.disabled = true;
            
            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                link.download = `${currentRecord.store_name}_è¯Šæ–­æŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            } finally {
                exportImageBtn.innerHTML = '<i class="fas fa-image mr-2"></i>ä¿å­˜é•¿å›¾';
                exportImageBtn.disabled = false;
            }
        });

        // äº‹ä»¶ç›‘å¬å™¨
        loadData.addEventListener('click', loadSurveyData);
        exportCSV.addEventListener('click', downloadCSV);
        limitSelect.addEventListener('change', (e) => {
            limit = parseInt(e.target.value);
            currentPage = 1;
            loadSurveyData();
        });
        prevPage.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadSurveyData();
            }
        });
        nextPage.addEventListener('click', () => {
            currentPage++;
            loadSurveyData();
        });
        closeModal.addEventListener('click', () => {
            detailModal.classList.remove('active');
        });
        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                detailModal.classList.remove('active');
            }
        });

        // åŠ è½½æ•°æ®
        async function loadSurveyData() {
            const api = apiUrl.value.trim();
            const key = adminKey.value.trim();

            if (!api || !key) {
                showStatus('error', 'è¯·è¾“å…¥APIåœ°å€å’Œç®¡ç†å‘˜å¯†é’¥');
                return;
            }

            toggleLoading(true);
            showStatus('checking', 'æ­£åœ¨åŠ è½½æ•°æ®...');

            try {
                const offset = (currentPage - 1) * limit;
                const response = await fetch(`${api}/api/surveys?limit=${limit}&offset=${offset}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': key,
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(30000)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentData = data.rows || [];
                    totalRecords = data.total || 0;
                    
                    displayData();
                    updateStats();
                    updatePagination();
                    showStatus('connected', `æˆåŠŸåŠ è½½ ${currentData.length} æ¡è®°å½•`);
                    
                    statsSection.classList.remove('hidden');
                    paginationSection.classList.remove('hidden');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                let errorMessage = 'åŠ è½½å¤±è´¥: ';
                
                if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                    errorMessage += 'è¯·æ±‚è¶…æ—¶';
                } else if (error.message.includes('401')) {
                    errorMessage += 'ç®¡ç†å‘˜å¯†é’¥é”™è¯¯';
                } else {
                    errorMessage += error.message;
                }
                
                showStatus('error', errorMessage);
            } finally {
                toggleLoading(false);
            }
        }

        // æ˜¾ç¤ºæ•°æ®
        function displayData() {
            if (currentData.length === 0) {
                dataContainer.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>æš‚æ— æ•°æ®</p>
                    </div>
                `;
                return;
            }

            const table = document.createElement('table');
            table.className = 'data-table w-full';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>ID</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>é—¨åº—è¯†åˆ«ç </th>
                    <th>é—¨åº—åç§°</th>
                    <th>ä¸šæ€ç±»å‹</th>
                    <th>æœˆè¥æ”¶</th>
                    <th>æ—¥å‡å®¢æµ</th>
                    <th>æ›´æ–°æ¬¡æ•°</th>
                    <th>æ“ä½œ</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            currentData.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.id}</td>
                    <td>${formatDate(record.timestamp)}</td>
                    <td><span class="font-mono text-blue-600">${record.store_identifier || '-'}</span></td>
                    <td>${record.store_name || '-'}</td>
                    <td>${record.business_type || '-'}</td>
                    <td>${formatNumber(record.monthly_revenue)}</td>
                    <td>${record.daily_customers || '-'}</td>
                    <td><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${record.update_count || 0}æ¬¡</span></td>
                    <td>
                        <button onclick="viewRecord(${record.id})" class="text-blue-500 hover:text-blue-700 mr-2" title="æŸ¥çœ‹è¯¦æƒ…">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="viewDiagnosis(${record.id})" class="text-purple-500 hover:text-purple-700" title="AIè¯Šæ–­">
                            <i class="fas fa-stethoscope"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            dataContainer.innerHTML = '';
            dataContainer.appendChild(table);
        }

        // æŸ¥çœ‹è¯¦æƒ…
        window.viewRecord = function(id) {
            const record = currentData.find(r => r.id === id);
            if (!record) return;
            currentRecord = record;

            document.getElementById('modalTitle').textContent = 'æ•°æ®è¯¦æƒ…';
            
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="details"]').classList.add('active');
            document.getElementById('detailsTab').classList.add('active');
            exportImageBtn.classList.add('hidden');

            const sections = [
                {
                    title: 'åŸºæœ¬ä¿¡æ¯',
                    icon: 'fa-info-circle',
                    color: 'blue',
                    fields: [
                        { label: 'è®°å½•ID', value: record.id },
                        { label: 'æäº¤æ—¶é—´', value: formatDate(record.timestamp) },
                        { label: 'é—¨åº—è¯†åˆ«ç ', value: record.store_identifier },
                        { label: 'é—¨åº—åç§°', value: record.store_name },
                        { label: 'ä¸šæ€ç±»å‹', value: record.business_type },
                        { label: 'é—¨åº—é¢ç§¯', value: formatNumber(record.store_area) + ' å¹³æ–¹ç±³' },
                        { label: 'å•†åœˆæƒ…å†µ', value: record.business_circle },
                        { label: 'è£…ä¿®æ¡£æ¬¡', value: record.decoration_level },
                        { label: 'æ›´æ–°æ¬¡æ•°', value: record.update_count || 0 }
                    ]
                },
                {
                    title: 'è´¢åŠ¡æ•°æ®',
                    icon: 'fa-money-bill-wave',
                    color: 'green',
                    fields: [
                        { label: 'æœˆè¥ä¸šæ”¶å…¥', value: 'Â¥' + formatNumber(record.monthly_revenue) },
                        { label: 'çº¿ä¸Šè¥æ”¶', value: 'Â¥' + formatNumber(record.online_revenue) },
                        { label: 'é£Ÿææˆæœ¬', value: 'Â¥' + formatNumber(record.food_cost) },
                        { label: 'äººåŠ›æˆæœ¬', value: 'Â¥' + formatNumber(record.labor_cost) },
                        { label: 'ç§Ÿé‡‘æˆæœ¬', value: 'Â¥' + formatNumber(record.rent_cost) },
                        { label: 'æ°´ç”µæ°”æˆæœ¬', value: 'Â¥' + formatNumber(record.utility_cost) },
                        { label: 'è¥é”€è´¹ç”¨', value: 'Â¥' + formatNumber(record.marketing_cost) }
                    ]
                },
                {
                    title: 'è¿è¥æ•°æ®',
                    icon: 'fa-chart-line',
                    color: 'purple',
                    fields: [
                        { label: 'æ—¥å‡å®¢æµ', value: record.daily_customers + ' äºº/å¤©' },
                        { label: 'åº§ä½æ•°', value: record.seats + ' ä¸ª' },
                        { label: 'æ€»å®¢æµ', value: formatNumber(record.total_customers) + ' äºº/æœˆ' },
                        { label: 'å¤è´­è€å®¢æˆ·', value: formatNumber(record.repeat_customers) + ' äºº/æœˆ' },
                        { label: 'çº¿ä¸Šä¸»è¥å¹³å°', value: record.main_platforms },
                        { label: 'è¥é”€æƒ…å†µ', value: record.marketing_situation }
                    ]
                },
                {
                    title: 'ä½“éªŒæ•°æ®',
                    icon: 'fa-star',
                    color: 'orange',
                    fields: [
                        { label: 'å¹³å‡è¯„åˆ†', value: record.average_rating },
                        { label: 'æ€»è¯„è®ºæ•°', value: formatNumber(record.total_reviews) + ' æ¡/æœˆ' },
                        { label: 'å·®è¯„æ•°', value: formatNumber(record.bad_reviews) + ' æ¡/æœˆ' },
                        { label: 'æœåŠ¡å·®è¯„', value: formatNumber(record.service_bad_reviews) + ' æ¡/æœˆ' },
                        { label: 'å£å‘³å·®è¯„', value: formatNumber(record.taste_bad_reviews) + ' æ¡/æœˆ' },
                        { label: 'çŸ­è§†é¢‘å‘å¸ƒé‡', value: formatNumber(record.short_video_count) + ' æ¡/æœˆ' },
                        { label: 'ç›´æ’­åœºæ¬¡', value: formatNumber(record.live_stream_count) + ' æ¬¡/æœˆ' }
                    ]
                }
            ];

            let html = '';
            sections.forEach(section => {
                html += `
                    <div class="bg-${section.color}-50 rounded-lg p-4 border border-${section.color}-200">
                        <h3 class="text-lg font-semibold text-${section.color}-800 mb-3 flex items-center">
                            <i class="fas ${section.icon} mr-2"></i>${section.title}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${section.fields.map(field => `
                                <div>
                                    <div class="text-sm text-${section.color}-600 font-medium">${field.label}</div>
                                    <div class="text-${section.color}-900">${field.value || '-'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('modalContent').innerHTML = html;
            detailModal.classList.add('active');
        };

        // æŸ¥çœ‹è¯Šæ–­
        window.viewDiagnosis = function(id) {
            const record = currentData.find(r => r.id === id);
            if (!record) return;
            currentRecord = record;

            document.getElementById('modalTitle').textContent = 'AIè¯Šæ–­æŠ¥å‘Š';
            
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="diagnosis"]').classList.add('active');
            document.getElementById('diagnosisTab').classList.add('active');
            exportImageBtn.classList.remove('hidden');

            generateDiagnosis(record);
            detailModal.classList.add('active');
        };

        // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
        function generateDiagnosis(data) {
            const report = diagnosis.diagnose(data);
            const kpi = diagnosis.calculateKPI(data);
            const benchmark = diagnosis.industryBenchmarks[data.business_type] || diagnosis.industryBenchmarks['å…¶ä»–'];
            
            // ä½¿ç”¨v2ç‰ˆæœ¬çš„æŠ¥å‘Šç”Ÿæˆ
            const html = diagnosis.generateReport(data, kpi, benchmark);
            document.getElementById('diagnosisContent').innerHTML = html;
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${report.dimensionScores.cost >= 80 ? '#2ecc71' : report.dimensionScores.cost >= 60 ? '#f39c12' : '#e74c3c'}">${report.dimensionScores.cost}</div>
                            <div class="metric-label">æˆæœ¬æ§åˆ¶</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${report.dimensionScores.cost >= 80 ? 'ä¼˜ç§€' : report.dimensionScores.cost >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${report.dimensionScores.efficiency >= 80 ? '#2ecc71' : report.dimensionScores.efficiency >= 60 ? '#f39c12' : '#e74c3c'}">${report.dimensionScores.efficiency}</div>
                            <div class="metric-label">è¿è¥æ•ˆç‡</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${report.dimensionScores.efficiency >= 80 ? 'ä¼˜ç§€' : report.dimensionScores.efficiency >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${report.dimensionScores.customer >= 80 ? '#2ecc71' : report.dimensionScores.customer >= 60 ? '#f39c12' : '#e74c3c'}">${report.dimensionScores.customer}</div>
                            <div class="metric-label">å®¢æˆ·ä½“éªŒ</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${report.dimensionScores.customer >= 80 ? 'ä¼˜ç§€' : report.dimensionScores.customer >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${report.dimensionScores.marketing >= 80 ? '#2ecc71' : report.dimensionScores.marketing >= 60 ? '#f39c12' : '#e74c3c'}">${report.dimensionScores.marketing}</div>
                            <div class="metric-label">è¥é”€èƒ½åŠ›</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${report.dimensionScores.marketing >= 80 ? 'ä¼˜ç§€' : report.dimensionScores.marketing >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›'}
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${report.dimensionScores.location >= 80 ? '#2ecc71' : report.dimensionScores.location >= 60 ? '#f39c12' : '#e74c3c'}">${report.dimensionScores.location}</div>
                            <div class="metric-label">é€‰å€åŒ¹é…</div>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">
                                ${report.dimensionScores.location >= 80 ? 'ä¼˜ç§€' : report.dimensionScores.location >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›'}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç»è¥æ•°æ®æ¦‚è§ˆ
            const grossProfit = Math.round((data.monthly_revenue || 0) * kpi.gross_margin);
            const totalCost = (data.food_cost || 0) + (data.labor_cost || 0) + (data.rent_cost || 0) + (data.marketing_cost || 0) + (data.utility_cost || 0);
            const costRate = (totalCost / (data.monthly_revenue || 1)) * 100;
            
            html += `
                <div class="diagnosis-section">
                    <h3>äºŒã€ç»è¥æ•°æ®æ¦‚è§ˆ</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="metric-card" style="border-top-color: #3b82f6;">
                            <div class="metric-label">æœˆè¥ä¸šé¢</div>
                            <div class="metric-value" style="font-size: 20px; color: #3b82f6;">Â¥${formatNumber(data.monthly_revenue)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                è¡Œä¸šå¹³å‡: Â¥${formatNumber(Math.round(benchmark.revenue_per_sqm * (data.store_area || 100)))}
                            </div>
                        </div>
                        <div class="metric-card" style="border-top-color: #10b981;">
                            <div class="metric-label">é¢„ä¼°æœˆæ¯›åˆ©</div>
                            <div class="metric-value" style="font-size: 20px; color: #10b981;">Â¥${formatNumber(grossProfit)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                æ¯›åˆ©ç‡: ${(kpi.gross_margin * 100).toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card" style="border-top-color: #f59e0b;">
                            <div class="metric-label">æœˆæ€»æˆæœ¬</div>
                            <div class="metric-value" style="font-size: 20px; color: #f59e0b;">Â¥${formatNumber(totalCost)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                æˆæœ¬ç‡: ${costRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric-card" style="border-top-color: #8b5cf6;">
                            <div class="metric-label">æœˆå®¢æµé‡</div>
                            <div class="metric-value" style="font-size: 20px; color: #8b5cf6;">${formatNumber(data.total_customers)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                æ—¥å‡: ${Math.round((data.total_customers || 0) / 30)}äºº
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // è¡Œä¸šå¯¹æ¯”åˆ†æ
            html += `
                <div class="diagnosis-section">
                    <h3>ä¸‰ã€è¡Œä¸šå¯¹æ¯”åˆ†æ (${data.business_type})</h3>
                    <table class="health-table">
                        <thead>
                            <tr>
                                <th>å¯¹æ¯”æŒ‡æ ‡</th>
                                <th>æ‚¨çš„é—¨åº—</th>
                                <th>è¡Œä¸šæ ‡å‡†</th>
                                <th>å·®è·åˆ†æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ç¿»å°ç‡</td>
                                <td><strong>${kpi.table_turnover.toFixed(1)}æ¬¡/å¤©</strong></td>
                                <td>${benchmark.table_turnover}æ¬¡/å¤©</td>
                                <td class="${kpi.table_turnover >= benchmark.table_turnover ? 'status-healthy' : 'status-warning'}">
                                    ${kpi.table_turnover >= benchmark.table_turnover ? 'è¾¾æ ‡ âœ“' : 'ä½äºæ ‡å‡† ' + ((benchmark.table_turnover - kpi.table_turnover).toFixed(1)) + 'æ¬¡'}
                                </td>
                            </tr>
                            <tr>
                                <td>æ¯›åˆ©ç‡</td>
                                <td><strong>${(kpi.gross_margin * 100).toFixed(1)}%</strong></td>
                                <td>${(benchmark.gross_margin * 100).toFixed(1)}%</td>
                                <td class="${kpi.gross_margin >= benchmark.gross_margin ? 'status-healthy' : 'status-warning'}">
                                    ${kpi.gross_margin >= benchmark.gross_margin ? 'è¾¾æ ‡ âœ“' : 'ä½äºæ ‡å‡† ' + ((benchmark.gross_margin - kpi.gross_margin) * 100).toFixed(1) + '%'}
                                </td>
                            </tr>
                            <tr>
                                <td>åªæ•ˆ</td>
                                <td><strong>Â¥${Math.round(kpi.revenue_per_sqm)}/ã¡</strong></td>
                                <td>Â¥${benchmark.revenue_per_sqm}/ã¡</td>
                                <td class="${kpi.revenue_per_sqm >= benchmark.revenue_per_sqm ? 'status-healthy' : 'status-warning'}">
                                    ${kpi.revenue_per_sqm >= benchmark.revenue_per_sqm ? 'è¾¾æ ‡ âœ“' : 'ä½äºæ ‡å‡† Â¥' + Math.round(benchmark.revenue_per_sqm - kpi.revenue_per_sqm)}
                                </td>
                            </tr>
                            <tr>
                                <td>å®¢å•ä»·</td>
                                <td><strong>Â¥${Math.round(kpi.avg_spending)}</strong></td>
                                <td>Â¥${benchmark.avg_spending || 50}</td>
                                <td class="${kpi.avg_spending >= (benchmark.avg_spending || 50) ? 'status-healthy' : 'status-warning'}">
                                    ${kpi.avg_spending >= (benchmark.avg_spending || 50) ? 'è¾¾æ ‡ âœ“' : 'ä½äºæ ‡å‡† Â¥' + Math.round((benchmark.avg_spending || 50) - kpi.avg_spending)}
                                </td>
                            </tr>
                            <tr>
                                <td>çº¿ä¸Šå æ¯”</td>
                                <td><strong>${(kpi.takeaway_ratio * 100).toFixed(1)}%</strong></td>
                                <td>${(benchmark.takeaway_ratio * 100).toFixed(1)}%</td>
                                <td class="${Math.abs(kpi.takeaway_ratio - benchmark.takeaway_ratio) < 0.1 ? 'status-healthy' : 'status-warning'}">
                                    ${Math.abs(kpi.takeaway_ratio - benchmark.takeaway_ratio) < 0.1 ? 'åˆç†èŒƒå›´ âœ“' : kpi.takeaway_ratio > benchmark.takeaway_ratio ? 'é«˜äºæ ‡å‡†' : 'ä½äºæ ‡å‡†'}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="info-card" style="margin-top: 15px; background: #f0f9ff; border-left-color: #3b82f6;">
                        <p style="font-size: 13px; line-height: 1.6;">
                            <strong>åˆ†æ:</strong> 
                            ${kpi.table_turnover < benchmark.table_turnover ? 'ç¿»å°ç‡åä½ï¼Œå»ºè®®ä¼˜åŒ–å‡ºé¤é€Ÿåº¦å’ŒæœåŠ¡æµç¨‹ã€‚' : ''}
                            ${kpi.gross_margin < benchmark.gross_margin ? 'æ¯›åˆ©ç‡ä½äºè¡Œä¸šæ°´å¹³ï¼Œéœ€å…³æ³¨æˆæœ¬æ§åˆ¶ã€‚' : ''}
                            ${kpi.revenue_per_sqm < benchmark.revenue_per_sqm ? 'åªæ•ˆä¸è¶³ï¼Œå¯è€ƒè™‘æå‡å®¢æµæˆ–ä¼˜åŒ–ç©ºé—´åˆ©ç”¨ã€‚' : ''}
                            ${kpi.table_turnover >= benchmark.table_turnover && kpi.gross_margin >= benchmark.gross_margin && kpi.revenue_per_sqm >= benchmark.revenue_per_sqm ? 'ä¸»è¦æŒ‡æ ‡å‡è¾¾åˆ°æˆ–è¶…è¿‡è¡Œä¸šæ ‡å‡†ï¼Œç»§ç»­ä¿æŒï¼' : ''}
                        </p>
                    </div>
                </div>
            `;

            // é—¨åº—åŸºæœ¬ä¿¡æ¯
            html += `
                <div class="diagnosis-section">
                    <h3>å››ã€é—¨åº—åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="store-info-grid">
                        <div class="store-info-item"><label>é—¨åº—åç§°</label><value>${data.store_name}</value></div>
                        <div class="store-info-item"><label>ä¸šæ€ç±»å‹</label><value>${data.business_type}</value></div>
                        <div class="store-info-item"><label>é—¨åº—é¢ç§¯</label><value>${data.store_area}ã¡</value></div>
                        <div class="store-info-item"><label>å•†åœˆæƒ…å†µ</label><value>${data.business_circle}</value></div>
                        <div class="store-info-item"><label>è£…ä¿®æ¡£æ¬¡</label><value>${data.decoration_level}</value></div>
                        <div class="store-info-item"><label>æœˆè¥æ”¶</label><value>Â¥${formatNumber(data.monthly_revenue)}</value></div>
                        <div class="store-info-item"><label>åº§ä½æ•°</label><value>${data.seats}ä¸ª</value></div>
                        <div class="store-info-item"><label>æ—¥å‡å®¢æµ</label><value>${data.daily_customers}äºº</value></div>
                    </div>
                </div>
            `;

            // è¯¦ç»†æˆæœ¬ç»“æ„åˆ†æ
            const totalCostCalc = (data.food_cost || 0) + (data.labor_cost || 0) + (data.rent_cost || 0) + (data.marketing_cost || 0) + (data.utility_cost || 0);
            html += `
                <div class="diagnosis-section">
                    <h3>äº”ã€æˆæœ¬ç»“æ„æ·±åº¦åˆ†æ</h3>
                    
                    <!-- æˆæœ¬è¡¨æ ¼ -->
                    <div style="margin-bottom: 20px;">
                        <table class="health-table">
                            <thead>
                                <tr>
                                    <th>æˆæœ¬é¡¹ç›®</th>
                                    <th>é‡‘é¢</th>
                                    <th>å è¥æ”¶æ¯”</th>
                                    <th>å¥åº·å€¼</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>é£Ÿææˆæœ¬</td>
                                    <td>Â¥${formatNumber(data.food_cost)}</td>
                                    <td><strong>${(kpi.food_cost_ratio * 100).toFixed(1)}%</strong></td>
                                    <td class="${kpi.food_cost_ratio <= 0.35 ? 'status-healthy' : kpi.food_cost_ratio <= 0.40 ? 'status-warning' : 'status-danger'}">
                                        ${kpi.food_cost_ratio <= 0.35 ? 'å¥åº·' : kpi.food_cost_ratio <= 0.40 ? 'åé«˜' : 'è¿‡é«˜'}
                                    </td>
                                </tr>
                                <tr>
                                    <td>äººåŠ›æˆæœ¬</td>
                                    <td>Â¥${formatNumber(data.labor_cost)}</td>
                                    <td><strong>${(kpi.labor_cost_ratio * 100).toFixed(1)}%</strong></td>
                                    <td class="${kpi.labor_cost_ratio <= 0.30 ? 'status-healthy' : kpi.labor_cost_ratio <= 0.35 ? 'status-warning' : 'status-danger'}">
                                        ${kpi.labor_cost_ratio <= 0.30 ? 'å¥åº·' : kpi.labor_cost_ratio <= 0.35 ? 'åé«˜' : 'è¿‡é«˜'}
                                    </td>
                                </tr>
                                <tr>
                                    <td>ç§Ÿé‡‘æˆæœ¬</td>
                                    <td>Â¥${formatNumber(data.rent_cost)}</td>
                                    <td><strong>${(kpi.rent_cost_ratio * 100).toFixed(1)}%</strong></td>
                                    <td class="${kpi.rent_cost_ratio <= 0.20 ? 'status-healthy' : kpi.rent_cost_ratio <= 0.25 ? 'status-warning' : 'status-danger'}">
                                        ${kpi.rent_cost_ratio <= 0.20 ? 'å¥åº·' : kpi.rent_cost_ratio <= 0.25 ? 'åé«˜' : 'è¿‡é«˜'}
                                    </td>
                                </tr>
                                <tr>
                                    <td>è¥é”€æˆæœ¬</td>
                                    <td>Â¥${formatNumber(data.marketing_cost)}</td>
                                    <td><strong>${(kpi.marketing_cost_ratio * 100).toFixed(1)}%</strong></td>
                                    <td class="${kpi.marketing_cost_ratio <= 0.10 ? 'status-healthy' : kpi.marketing_cost_ratio <= 0.15 ? 'status-warning' : 'status-danger'}">
                                        ${kpi.marketing_cost_ratio <= 0.10 ? 'å¥åº·' : kpi.marketing_cost_ratio <= 0.15 ? 'åé«˜' : 'è¿‡é«˜'}
                                    </td>
                                </tr>
                                <tr>
                                    <td>æ°´ç”µæ°”æˆæœ¬</td>
                                    <td>Â¥${formatNumber(data.utility_cost)}</td>
                                    <td><strong>${(kpi.utility_cost_ratio * 100).toFixed(1)}%</strong></td>
                                    <td class="${kpi.utility_cost_ratio <= 0.05 ? 'status-healthy' : kpi.utility_cost_ratio <= 0.07 ? 'status-warning' : 'status-danger'}">
                                        ${kpi.utility_cost_ratio <= 0.05 ? 'å¥åº·' : kpi.utility_cost_ratio <= 0.07 ? 'åé«˜' : 'è¿‡é«˜'}
                                    </td>
                                </tr>
                                <tr style="background: #f0f9ff;">
                                    <td><strong>æ€»æˆæœ¬</strong></td>
                                    <td><strong>Â¥${formatNumber(totalCostCalc)}</strong></td>
                                    <td><strong>${((totalCostCalc / data.monthly_revenue) * 100).toFixed(1)}%</strong></td>
                                    <td class="${kpi.gross_margin >= 0.55 ? 'status-healthy' : kpi.gross_margin >= 0.45 ? 'status-warning' : 'status-danger'}">
                                        æ¯›åˆ©${(kpi.gross_margin * 100).toFixed(1)}%
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- æˆæœ¬ä¼˜åŒ–å»ºè®® -->
                    <div class="info-card">
                        <h4 style="font-weight: 600; margin-bottom: 10px;">ğŸ’¡ æˆæœ¬ä¼˜åŒ–å»ºè®®</h4>
                        ${kpi.food_cost_ratio > 0.35 ? `
                        <div style="margin: 12px 0; padding: 12px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <strong>é£Ÿææˆæœ¬åé«˜:</strong>
                            <ul style="margin: 8px 0 0 20px; font-size: 13px; line-height: 1.8;">
                                <li>å»ºç«‹æ ‡å‡†åŒ–é…æ–¹,ä¸¥æ ¼æ§åˆ¶å‡ºå“ä»½é‡</li>
                                <li>ä¼˜åŒ–é‡‡è´­æ¸ é“,å¯»æ±‚æ‰¹é‡è®®ä»·</li>
                                <li>é™ä½æŸè€—ç‡,æ”¹è¿›åº“å­˜ç®¡ç†</li>
                                <li>é¢„è®¡å¯é™ä½æˆæœ¬ç‡3-5%,æœˆèŠ‚çœÂ¥${formatNumber(Math.round(data.monthly_revenue * 0.04))}</li>
                            </ul>
                        </div>
                        ` : ''}
                        ${kpi.labor_cost_ratio > 0.30 ? `
                        <div style="margin: 12px 0; padding: 12px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <strong>äººåŠ›æˆæœ¬åé«˜:</strong>
                            <ul style="margin: 8px 0 0 20px; font-size: 13px; line-height: 1.8;">
                                <li>ä¼˜åŒ–æ’ç­,æé«˜äººæ•ˆ</li>
                                <li>å¼•å…¥è‡ªåŠ©ç‚¹é¤ç­‰é™æœ¬å·¥å…·</li>
                                <li>æŒ‰é«˜å³°æ—¶æ®µå¼¹æ€§é…ç½®äººå‘˜</li>
                                <li>é¢„è®¡å¯æå‡äººæ•ˆ20%,æœˆèŠ‚çœÂ¥${formatNumber(Math.round(data.labor_cost * 0.15))}</li>
                            </ul>
                        </div>
                        ` : ''}
                        ${kpi.marketing_cost_ratio > 0.10 ? `
                        <div style="margin: 12px 0; padding: 12px; background: #fef2f2; border-left: 3px solid #ef4444; border-radius: 4px;">
                            <strong>è¥é”€æˆæœ¬åé«˜:</strong>
                            <ul style="margin: 8px 0 0 20px; font-size: 13px; line-height: 1.8;">
                                <li>ä¼˜åŒ–æŠ•æµç­–ç•¥,æé«˜ROI</li>
                                <li>å»ºç«‹ç§åŸŸæµé‡,é™ä½å¹³å°ä¾èµ–</li>
                                <li>åŠ å¼ºå†…å®¹è¥é”€,æå‡è‡ªç„¶æµé‡</li>
                                <li>é¢„è®¡å¯é™ä½è·å®¢æˆæœ¬25%,æœˆèŠ‚çœÂ¥${formatNumber(Math.round(data.marketing_cost * 0.25))}</li>
                            </ul>
                        </div>
                        ` : ''}
                        ${kpi.food_cost_ratio <= 0.35 && kpi.labor_cost_ratio <= 0.30 && kpi.marketing_cost_ratio <= 0.10 ? `
                        <div style="padding: 12px; background: #f0fdf4; border-left: 3px solid #22c55e; border-radius: 4px;">
                            <p style="color: #22c55e; font-weight: 600;">âœ“ æˆæœ¬æ§åˆ¶è‰¯å¥½,ç»§ç»­ä¿æŒ!</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // å®¢æˆ·åˆ†æ
            const customerLifetimeValue = kpi.avg_spending * (data.total_customers > 0 ? data.repeat_customers / data.total_customers * 12 : 0);
            html += `
                <div class="diagnosis-section">
                    <h3>å…­ã€å®¢æˆ·è¡Œä¸ºæ·±åº¦åˆ†æ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="metric-card" style="border-top-color: #6366f1;">
                            <div class="metric-label">å®¢å•ä»·</div>
                            <div class="metric-value" style="font-size: 24px; color: #6366f1;">Â¥${Math.round(kpi.avg_spending)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                è¡Œä¸šå¹³å‡: Â¥${benchmark.avg_spending || 50}
                            </div>
                        </div>
                        <div class="metric-card" style="border-top-color: #ec4899;">
                            <div class="metric-label">å¤è´­ç‡</div>
                            <div class="metric-value" style="font-size: 24px; color: #ec4899;">${(kpi.member_repurchase * 100).toFixed(1)}%</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                ${kpi.member_repurchase >= 0.25 ? 'ä¼˜ç§€æ°´å¹³' : kpi.member_repurchase >= 0.15 ? 'åˆæ ¼æ°´å¹³' : 'éœ€æå‡'}
                            </div>
                        </div>
                        <div class="metric-card" style="border-top-color: #14b8a6;">
                            <div class="metric-label">å®¢æˆ·ç»ˆèº«ä»·å€¼(LTV)</div>
                            <div class="metric-value" style="font-size: 24px; color: #14b8a6;">Â¥${Math.round(customerLifetimeValue)}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                é¢„ä¼°å¹´åº¦è´¡çŒ®
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="info-card">
                            <h4 style="font-weight: 600; margin-bottom: 10px;">ğŸ“Š å®¢æµç»“æ„åˆ†æ</h4>
                            <table style="width: 100%; font-size: 13px;">
                                <tr>
                                    <td style="padding: 6px 0;">æœˆæ€»å®¢æµ:</td>
                                    <td style="text-align: right;"><strong>${formatNumber(data.total_customers)}äºº</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0;">æ–°å®¢æˆ·(ä¼°ç®—):</td>
                                    <td style="text-align: right;"><strong>${formatNumber(data.total_customers - data.repeat_customers)}äºº</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0;">è€å®¢æˆ·:</td>
                                    <td style="text-align: right;"><strong>${formatNumber(data.repeat_customers)}äºº</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0;">æ–°å®¢å æ¯”:</td>
                                    <td style="text-align: right;"><strong>${((1 - kpi.member_repurchase) * 100).toFixed(1)}%</strong></td>
                                </tr>
                                <tr style="border-top: 1px solid #e5e7eb;">
                                    <td style="padding: 6px 0;">æ—¥å‡åˆ°åº—å®¢æµ:</td>
                                    <td style="text-align: right;"><strong>${data.daily_customers}äºº</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0;">æ—¥å‡ç¿»å°ç‡:</td>
                                    <td style="text-align: right;"><strong>${kpi.table_turnover.toFixed(1)}æ¬¡</strong></td>
                                </tr>
                            </table>
                        </div>
                        <div class="info-card">
                            <h4 style="font-weight: 600; margin-bottom: 10px;">ğŸ’° è¥æ”¶è´¡çŒ®åˆ†æ</h4>
                            <table style="width: 100%; font-size: 13px;">
                                <tr>
                                    <td style="padding: 6px 0;">å ‚é£Ÿè¥æ”¶:</td>
                                    <td style="text-align: right;"><strong>Â¥${formatNumber(data.monthly_revenue - data.online_revenue)}</strong></td>
                                    <td style="text-align: right;">${((1 - kpi.takeaway_ratio) * 100).toFixed(1)}%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0;">çº¿ä¸Šè¥æ”¶:</td>
                                    <td style="text-align: right;"><strong>Â¥${formatNumber(data.online_revenue)}</strong></td>
                                    <td style="text-align: right;">${(kpi.takeaway_ratio * 100).toFixed(1)}%</td>
                                </tr>
                                <tr style="border-top: 1px solid #e5e7eb;">
                                    <td style="padding: 6px 0;">æ–°å®¢è´¡çŒ®(ä¼°):</td>
                                    <td style="text-align: right;"><strong>Â¥${formatNumber(data.monthly_revenue * (1 - kpi.member_repurchase))}</strong></td>
                                    <td style="text-align: right;">${((1 - kpi.member_repurchase) * 100).toFixed(1)}%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 6px 0;">è€å®¢è´¡çŒ®(ä¼°):</td>
                                    <td style="text-align: right;"><strong>Â¥${formatNumber(data.monthly_revenue * kpi.member_repurchase)}</strong></td>
                                    <td style="text-align: right;">${(kpi.member_repurchase * 100).toFixed(1)}%</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div class="info-card" style="margin-top: 12px; background: #eff6ff; border-left-color: #3b82f6;">
                        <h4 style="font-weight: 600; margin-bottom: 8px;">ğŸ’¡ å®¢æˆ·ç­–ç•¥å»ºè®®</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8;">
                            ${kpi.member_repurchase < 0.25 ? '<li><strong>æå‡å¤è´­ç‡:</strong> å»ºç«‹ä¼šå‘˜ä½“ç³»,è®¾è®¡è€å®¢æˆ·ä¸“å±ä¼˜æƒ ,é¢„è®¡å¯æå‡å¤è´­ç‡è‡³30%ä»¥ä¸Š</li>' : ''}
                            ${kpi.avg_spending < (benchmark.avg_spending || 50) ? '<li><strong>æå‡å®¢å•ä»·:</strong> ä¼˜åŒ–èœå•è®¾è®¡,æ¨å‡ºå¥—é¤ç»„åˆ,é¢„è®¡å¯æå‡å®¢å•ä»·15-20%</li>' : ''}
                            ${data.daily_customers < data.seats * 2 ? '<li><strong>å¢åŠ å®¢æµ:</strong> åŠ å¼ºçº¿ä¸Šè¥é”€,ä¼˜åŒ–é«˜å³°æ—¶æ®µè¿è¥,é¢„è®¡å¯æå‡æ—¥å®¢æµ20%</li>' : ''}
                            <li><strong>å®¢æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†:</strong> å½“å‰LTVä¸ºÂ¥${Math.round(customerLifetimeValue)},é€šè¿‡æå‡å¤è´­å¯ä½¿LTVå¢é•¿50%ä»¥ä¸Š</li>
                        </ul>
                    </div>
                </div>
            `;

            // è¥é”€æ¸ é“åˆ†æ
            html += `
                <div class="diagnosis-section">
                    <h3>ä¸ƒã€è¥é”€æ¸ é“æ•ˆæœåˆ†æ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="metric-card" style="border-top-color: #f59e0b;">
                                <div class="metric-label">è¥é”€å¥åº·åº¦è¯„åˆ†</div>
                                <div class="metric-value" style="font-size: 32px; color: #f59e0b;">${kpi.marketing_health_score}åˆ†</div>
                                <div class="score-badge ${diagnosis.getScoreBadgeClass(kpi.marketing_health_score)}" style="margin-top: 8px;">
                                    ${diagnosis.getScoreLabel(kpi.marketing_health_score)}
                                </div>
                            </div>
                            <div class="info-card" style="margin-top: 12px;">
                                <h4 style="font-weight: 600; margin-bottom: 8px;">çº¿ä¸Šå¹³å°è¡¨ç°</h4>
                                <table style="width: 100%; font-size: 13px;">
                                    <tr>
                                        <td style="padding: 6px 0;">ä¸»è¥å¹³å°:</td>
                                        <td style="text-align: right;"><strong>${data.main_platforms || '-'}</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;">å¹³å‡è¯„åˆ†:</td>
                                        <td style="text-align: right;"><strong>${data.average_rating}åˆ†</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;">æœˆæ€»è¯„è®º:</td>
                                        <td style="text-align: right;"><strong>${data.total_reviews}æ¡</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;">å·®è¯„ç‡:</td>
                                        <td style="text-align: right;" class="${kpi.negative_comment_rate <= 0.05 ? '' : 'color: #ef4444;'}">
                                            <strong>${(kpi.negative_comment_rate * 100).toFixed(1)}%</strong>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div>
                            <div class="metric-card" style="border-top-color: #8b5cf6;">
                                <div class="metric-label">å†…å®¹è¥é”€æŒ‡æ•°</div>
                                <div class="metric-value" style="font-size: 32px; color: #8b5cf6;">${kpi.content_marketing_index}åˆ†</div>
                                <div class="score-badge ${diagnosis.getScoreBadgeClass(kpi.content_marketing_index)}" style="margin-top: 8px;">
                                    ${diagnosis.getScoreLabel(kpi.content_marketing_index)}
                                </div>
                            </div>
                            <div class="info-card" style="margin-top: 12px;">
                                <h4 style="font-weight: 600; margin-bottom: 8px;">å†…å®¹è¿è¥æƒ…å†µ</h4>
                                <table style="width: 100%; font-size: 13px;">
                                    <tr>
                                        <td style="padding: 6px 0;">çŸ­è§†é¢‘å‘å¸ƒ:</td>
                                        <td style="text-align: right;"><strong>${data.short_video_count}æ¡/æœˆ</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;">ç›´æ’­åœºæ¬¡:</td>
                                        <td style="text-align: right;"><strong>${data.live_stream_count}æ¬¡/æœˆ</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;">è¿è¥æ–¹å¼:</td>
                                        <td style="text-align: right;"><strong>${data.marketing_situation || '-'}</strong></td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;">è¥é”€æŠ•å…¥:</td>
                                        <td style="text-align: right;"><strong>Â¥${formatNumber(data.marketing_cost)}/æœˆ</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card" style="margin-top: 12px; background: #fef3c7; border-left-color: #f59e0b;">
                        <h4 style="font-weight: 600; margin-bottom: 8px;">ğŸ“± è¥é”€ä¼˜åŒ–å»ºè®®</h4>
                        <div style="font-size: 13px; line-height: 1.8;">
                            ${kpi.content_marketing_index < 60 ? `
                            <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong>å†…å®¹è¥é”€å¾…åŠ å¼º:</strong>
                                <ul style="margin: 8px 0 0 20px;">
                                    ${data.short_video_count < 50 ? '<li>çŸ­è§†é¢‘æœˆå‘å¸ƒé‡å»ºè®®å¢è‡³50+æ¡,æå‡çº¿ä¸Šæ›å…‰</li>' : ''}
                                    ${data.live_stream_count < 15 ? '<li>å¢åŠ ç›´æ’­é¢‘æ¬¡è‡³15+æ¬¡/æœˆ,æå‡å®¢æˆ·ç²˜æ€§</li>' : ''}
                                    ${data.marketing_situation === 'æ— ' || data.marketing_situation === 'è€æ¿è¿è¥' ? '<li>è€ƒè™‘ç»„å»ºä¸“ä¸šè¿è¥å›¢é˜Ÿæˆ–æ‰¾ä¸“ä¸šä»£è¿è¥</li>' : ''}
                                </ul>
                            </div>
                            ` : ''}
                            ${kpi.negative_comment_rate > 0.05 ? `
                            <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong>å·®è¯„ç‡åé«˜(${(kpi.negative_comment_rate * 100).toFixed(1)}%):</strong>
                                <ul style="margin: 8px 0 0 20px;">
                                    <li>æœåŠ¡é—®é¢˜å ${(kpi.service_bad_review_rate * 100).toFixed(0)}%,å»ºç«‹æœåŠ¡SOPæ ‡å‡†</li>
                                    <li>å£å‘³é—®é¢˜å ${(kpi.taste_bad_review_rate * 100).toFixed(0)}%,åŠ å¼ºå‡ºå“ç¨³å®šæ€§</li>
                                    <li>å»ºç«‹å·®è¯„åº”å¯¹æœºåˆ¶,48å°æ—¶å†…å“åº”å¤„ç†</li>
                                </ul>
                            </div>
                            ` : ''}
                            ${kpi.marketing_cost_ratio > 0.10 ? `
                            <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong>è¥é”€ROIä¼˜åŒ–:</strong>
                                <ul style="margin: 8px 0 0 20px;">
                                    <li>å½“å‰è¥é”€æˆæœ¬å æ¯”${(kpi.marketing_cost_ratio * 100).toFixed(1)}%,å»ºè®®æ§åˆ¶åœ¨10%ä»¥å†…</li>
                                    <li>åŠ å¼ºç§åŸŸæµé‡å»ºè®¾,é™ä½å¹³å°ä¾èµ–,é¢„è®¡å¯èŠ‚çœ30%è·å®¢æˆæœ¬</li>
                                    <li>ä¼˜åŒ–æŠ•æ”¾ç­–ç•¥,å…³æ³¨ROIè€Œéå•çº¯æ›å…‰é‡</li>
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // æ ¸å¿ƒæŒ‡æ ‡å¥åº·æ£€æŸ¥
            html += `
                <div class="diagnosis-section">
                    <h3>å…«ã€æ ¸å¿ƒæŒ‡æ ‡å¥åº·æ£€æŸ¥</h3>
                    <table class="health-table">
                        <thead>
                            <tr>
                                <th>æŒ‡æ ‡åç§°</th>
                                <th>å½“å‰å€¼</th>
                                <th>å¥åº·çŠ¶æ€</th>
                                <th>è¯¦ç»†è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(report.healthCheck).map(item => `
                                <tr>
                                    <td><strong>${item.name}</strong></td>
                                    <td style="font-size: 15px;"><strong>${item.value}</strong></td>
                                    <td class="${item.statusClass}">${item.status}</td>
                                    <td style="font-size: 12px; line-height: 1.6;">${item.interpretation}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // é—®é¢˜è¯Šæ–­åˆ†çº§
            const urgentIssues = [];
            const importantIssues = [];
            const optimizationIssues = [];
            
            report.rootCauses.forEach(cause => {
                if (cause.phenomenon.includes('è¿‡é«˜') || cause.phenomenon.includes('è¿‡ä½')) {
                    urgentIssues.push(cause);
                } else if (cause.phenomenon.includes('åé«˜') || cause.phenomenon.includes('åä½')) {
                    importantIssues.push(cause);
                } else {
                    optimizationIssues.push(cause);
                }
            });

            html += `
                <div class="diagnosis-section">
                    <h3>ä¹ã€é—®é¢˜è¯Šæ–­åˆ†çº§</h3>
            `;

            if (urgentIssues.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #dc2626; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center;">
                            <span style="background: #dc2626; color: white; padding: 4px 12px; border-radius: 4px; margin-right: 10px; font-size: 12px;">ç´§æ€¥</span>
                            éœ€è¦ç«‹å³å¤„ç†çš„é—®é¢˜
                        </h4>
                        ${urgentIssues.map(cause => `
                            <div class="info-card" style="border-left: 4px solid #dc2626; background: #fef2f2;">
                                <h4 style="font-weight: 600; margin-bottom: 8px; color: #dc2626;">
                                    <i class="fas fa-exclamation-triangle"></i> ${cause.phenomenon}
                                </h4>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <p style="margin: 8px 0;"><strong>å¯èƒ½åŸå› :</strong></p>
                                    <ul style="margin: 0 0 8px 20px;">
                                        ${cause.causes.map(c => `<li>${c}</li>`).join('')}
                                    </ul>
                                    <p style="color: #666;"><strong>æ•°æ®æ”¯æ’‘:</strong> ${cause.dataSupport}</p>
                                    <p style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #dc2626;">
                                        <strong>å½±å“è¯„ä¼°:</strong> å¦‚ä¸åŠæ—¶å¤„ç†,å¯èƒ½å¯¼è‡´æœˆäºæŸå¢åŠ Â¥${Math.round(data.monthly_revenue * 0.05)}-${Math.round(data.monthly_revenue * 0.10)}
                                    </p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (importantIssues.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #f59e0b; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center;">
                            <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 4px; margin-right: 10px; font-size: 12px;">é‡è¦</span>
                            éœ€è¦å°½å¿«æ”¹è¿›çš„é—®é¢˜
                        </h4>
                        ${importantIssues.map(cause => `
                            <div class="info-card" style="border-left: 4px solid #f59e0b; background: #fffbeb;">
                                <h4 style="font-weight: 600; margin-bottom: 8px; color: #f59e0b;">
                                    <i class="fas fa-exclamation-circle"></i> ${cause.phenomenon}
                                </h4>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <p style="margin: 8px 0;"><strong>å¯èƒ½åŸå› :</strong></p>
                                    <ul style="margin: 0 0 8px 20px;">
                                        ${cause.causes.map(c => `<li>${c}</li>`).join('')}
                                    </ul>
                                    <p style="color: #666;"><strong>æ•°æ®æ”¯æ’‘:</strong> ${cause.dataSupport}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (optimizationIssues.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #3b82f6; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center;">
                            <span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 4px; margin-right: 10px; font-size: 12px;">ä¼˜åŒ–</span>
                            å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–çš„æ–¹å‘
                        </h4>
                        ${optimizationIssues.map(cause => `
                            <div class="info-card" style="border-left: 4px solid #3b82f6; background: #eff6ff;">
                                <h4 style="font-weight: 600; margin-bottom: 8px; color: #3b82f6;">
                                    <i class="fas fa-info-circle"></i> ${cause.phenomenon}
                                </h4>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <p style="margin: 8px 0;"><strong>ä¼˜åŒ–æ–¹å‘:</strong></p>
                                    <ul style="margin: 0 0 8px 20px;">
                                        ${cause.causes.map(c => `<li>${c}</li>`).join('')}
                                    </ul>
                                    <p style="color: #666;"><strong>æ•°æ®æ”¯æ’‘:</strong> ${cause.dataSupport}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (report.rootCauses.length === 0) {
                html += `
                    <div class="info-card" style="border-left-color: #22c55e; background: #f0fdf4;">
                        <p style="color: #22c55e; font-weight: 600; text-align: center; padding: 20px;">
                            <i class="fas fa-check-circle" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
                            æ­å–œ!æœªå‘ç°é‡å¤§ç»è¥é—®é¢˜,è¯·ä¿æŒå½“å‰è‰¯å¥½çŠ¶æ€!
                        </p>
                    </div>
                `;
            }

            html += `</div>`;

            // è¯¦ç»†æ”¹è¿›è¡ŒåŠ¨è®¡åˆ’
            if (report.actionPlans.length > 0) {
                html += `
                    <div class="diagnosis-section">
                        <h3>åã€è¯¦ç»†æ”¹è¿›è¡ŒåŠ¨è®¡åˆ’</h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                            ä»¥ä¸‹æ–¹æ¡ˆå·²æŒ‰ä¼˜å…ˆçº§å’ŒæŠ•å…¥äº§å‡ºæ¯”æ’åº,å»ºè®®ä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§é¡¹ç›®
                        </p>
                `;

                report.actionPlans.forEach((plan, index) => {
                    html += `
                        <div style="margin: 20px 0; padding: 20px; background: white; border-radius: 8px; border: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="font-weight: 600; color: #1f2937; margin: 0;">
                                    <span style="display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center; background: #3b82f6; color: white; border-radius: 50%; margin-right: 10px; font-size: 16px;">
                                        ${index + 1}
                                    </span>
                                    ${plan.problem}
                                </h4>
                                <span class="score-badge ${plan.priority === 'é«˜' ? 'score-poor' : plan.priority === 'ä¸­' ? 'score-average' : 'score-good'}">
                                    ${plan.priority}ä¼˜å…ˆçº§
                                </span>
                            </div>
                            
                            ${plan.solutions.map((solution, sIndex) => `
                                <div style="margin: 15px 0; padding: 15px; background: #f9fafb; border-left: 4px solid ${solution.priorityClass === 'priority-high' ? '#dc2626' : solution.priorityClass === 'priority-medium' ? '#f59e0b' : '#22c55e'}; border-radius: 4px;">
                                    <h5 style="font-weight: 600; margin-bottom: 10px; color: #1f2937;">
                                        æ–¹æ¡ˆ${sIndex + 1}: ${solution.measure}
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3" style="margin: 12px 0;">
                                        <div style="padding: 10px; background: white; border-radius: 4px;">
                                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ğŸ’° æŠ•å…¥æˆæœ¬</div>
                                            <div style="font-size: 15px; font-weight: 600; color: #dc2626;">${solution.cost}</div>
                                        </div>
                                        <div style="padding: 10px; background: white; border-radius: 4px;">
                                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ğŸ“ˆ é¢„æœŸæ•ˆæœ</div>
                                            <div style="font-size: 15px; font-weight: 600; color: #22c55e;">${solution.effect}</div>
                                        </div>
                                        <div style="padding: 10px; background: white; border-radius: 4px;">
                                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">â±ï¸ è§æ•ˆå‘¨æœŸ</div>
                                            <div style="font-size: 15px; font-weight: 600; color: #3b82f6;">${solution.timeline}</div>
                                        </div>
                                    </div>
                                    
                                    ${sIndex === 0 ? `
                                    <div style="margin-top: 12px; padding: 12px; background: #eff6ff; border-radius: 4px;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #1e40af;">
                                            <i class="fas fa-tasks"></i> å®æ–½æ­¥éª¤å»ºè®®:
                                        </div>
                                        <ol style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8;">
                                            ${solution.measure.includes('åŸ¹è®­') ? `
                                            <li>ç¬¬1å‘¨: åˆ¶å®šåŸ¹è®­æ–¹æ¡ˆå’Œè€ƒæ ¸æ ‡å‡†</li>
                                            <li>ç¬¬2-3å‘¨: ç»„ç»‡å‘˜å·¥åŸ¹è®­,å»ºç«‹æ ‡å‡†æµç¨‹</li>
                                            <li>ç¬¬4å‘¨: å®æ–½è€ƒæ ¸,è·Ÿè¿›æ”¹è¿›æ•ˆæœ</li>
                                            ` : solution.measure.includes('ä¼˜åŒ–') || solution.measure.includes('è°ƒæ•´') ? `
                                            <li>ç¬¬1å‘¨: æ•°æ®åˆ†æ,åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ</li>
                                            <li>ç¬¬2å‘¨: å°èŒƒå›´è¯•ç‚¹æµ‹è¯•</li>
                                            <li>ç¬¬3-4å‘¨: å…¨é¢æ¨å¹¿å¹¶æŒç»­ä¼˜åŒ–</li>
                                            ` : solution.measure.includes('å»ºç«‹') || solution.measure.includes('å¼•å…¥') ? `
                                            <li>ç¬¬1-2å‘¨: ç³»ç»Ÿ/å·¥å…·é€‰å‹å’Œé‡‡è´­</li>
                                            <li>ç¬¬3å‘¨: éƒ¨ç½²å®æ–½å’Œå‘˜å·¥åŸ¹è®­</li>
                                            <li>ç¬¬4å‘¨èµ·: æ­£å¼è¿è¡Œå¹¶æŒç»­ä¼˜åŒ–</li>
                                            ` : `
                                            <li>åˆ¶å®šè¯¦ç»†å®æ–½è®¡åˆ’</li>
                                            <li>åˆ†é˜¶æ®µæ¨è¿›æ‰§è¡Œ</li>
                                            <li>å®šæœŸè¯„ä¼°è°ƒæ•´</li>
                                            `}
                                        </ol>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // é£é™©é¢„è­¦
            const risks = [];
            if (kpi.gross_margin < 0.45) risks.push({ level: 'high', title: 'æ¯›åˆ©ç‡è¿‡ä½', desc: 'å½“å‰æ¯›åˆ©ç‡ä»…' + (kpi.gross_margin * 100).toFixed(1) + '%,å­˜åœ¨äºæŸé£é™©' });
            if (kpi.rent_cost_ratio > 0.25) risks.push({ level: 'high', title: 'ç§Ÿé‡‘è´Ÿæ‹…è¿‡é‡', desc: 'ç§Ÿé‡‘å æ¯”' + (kpi.rent_cost_ratio * 100).toFixed(1) + '%,è¶…å‡ºåˆç†èŒƒå›´' });
            if (kpi.negative_comment_rate > 0.10) risks.push({ level: 'medium', title: 'å·®è¯„ç‡å‘Šæ€¥', desc: 'å·®è¯„ç‡' + (kpi.negative_comment_rate * 100).toFixed(1) + '%,ä¸¥é‡å½±å“å“ç‰Œå½¢è±¡' });
            if (kpi.table_turnover < 2) risks.push({ level: 'medium', title: 'ç¿»å°ç‡æä½', desc: 'æ—¥å‡ç¿»å°' + kpi.table_turnover.toFixed(1) + 'æ¬¡,åº§ä½åˆ©ç”¨ç‡ä¸è¶³' });
            if (kpi.marketing_cost_ratio > 0.15) risks.push({ level: 'medium', title: 'è¥é”€æŠ•å…¥è¿‡åº¦', desc: 'è¥é”€æˆæœ¬' + (kpi.marketing_cost_ratio * 100).toFixed(1) + '%,ROIå ªå¿§' });

            if (risks.length > 0) {
                html += `
                    <div class="diagnosis-section">
                        <h3>åä¸€ã€é£é™©é¢„è­¦</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${risks.map(risk => `
                                <div class="info-card" style="border-left: 4px solid ${risk.level === 'high' ? '#dc2626' : '#f59e0b'}; background: ${risk.level === 'high' ? '#fef2f2' : '#fffbeb'};">
                                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                        <i class="fas fa-exclamation-triangle" style="color: ${risk.level === 'high' ? '#dc2626' : '#f59e0b'}; font-size: 20px; margin-right: 10px;"></i>
                                        <h4 style="font-weight: 600; color: ${risk.level === 'high' ? '#dc2626' : '#f59e0b'}; margin: 0;">
                                            ${risk.title}
                                        </h4>
                                    </div>
                                    <p style="font-size: 13px; color: #666; line-height: 1.6; margin: 0;">
                                        ${risk.desc}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // æ€»ç»“å»ºè®®
            html += `
                <div class="diagnosis-section">
                    <h3>åäºŒã€è¯Šæ–­æ€»ç»“ä¸å»ºè®®</h3>
                    <div class="info-card" style="background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); border: 2px solid #667eea; padding: 25px;">
                        <h4 style="font-weight: 600; margin-bottom: 15px; font-size: 16px; color: #1f2937;">
                            <i class="fas fa-clipboard-check" style="color: #667eea; margin-right: 8px;"></i>
                            ç»¼åˆè¯Šæ–­ç»“è®º
                        </h4>
                        <div style="font-size: 14px; line-height: 1.8; color: #374151;">
                            <p style="margin-bottom: 12px;">
                                <strong>${data.store_name}</strong>çš„æ€»ä½“å¥åº·è¯„åˆ†ä¸º<strong style="color: #667eea; font-size: 18px;"> ${report.overallScore}åˆ†</strong>,
                                ${report.overallScore >= 80 ? 'è¡¨ç°ä¼˜ç§€,æ•´ä½“ç»è¥çŠ¶å†µè‰¯å¥½ã€‚' : 
                                  report.overallScore >= 70 ? 'è¡¨ç°è‰¯å¥½,éƒ¨åˆ†æŒ‡æ ‡ä»æœ‰æå‡ç©ºé—´ã€‚' :
                                  report.overallScore >= 60 ? 'åŠæ ¼æ°´å¹³,éœ€è¦é‡ç‚¹æ”¹è¿›éƒ¨åˆ†ç»è¥ç¯èŠ‚ã€‚' : 
                                  'å­˜åœ¨è¾ƒå¤šé—®é¢˜,éœ€è¦ç³»ç»Ÿæ€§æ”¹è¿›ã€‚'}
                            </p>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <div style="font-weight: 600; margin-bottom: 10px; color: #1f2937;">ğŸ“Š äº”ç»´åº¦è¡¨ç°:</div>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li>æˆæœ¬æ§åˆ¶: ${report.dimensionScores.cost}åˆ† - ${report.dimensionScores.cost >= 80 ? 'ä¼˜ç§€âœ“' : report.dimensionScores.cost >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›âš ï¸'}</li>
                                    <li>è¿è¥æ•ˆç‡: ${report.dimensionScores.efficiency}åˆ† - ${report.dimensionScores.efficiency >= 80 ? 'ä¼˜ç§€âœ“' : report.dimensionScores.efficiency >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›âš ï¸'}</li>
                                    <li>å®¢æˆ·ä½“éªŒ: ${report.dimensionScores.customer}åˆ† - ${report.dimensionScores.customer >= 80 ? 'ä¼˜ç§€âœ“' : report.dimensionScores.customer >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›âš ï¸'}</li>
                                    <li>è¥é”€èƒ½åŠ›: ${report.dimensionScores.marketing}åˆ† - ${report.dimensionScores.marketing >= 80 ? 'ä¼˜ç§€âœ“' : report.dimensionScores.marketing >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›âš ï¸'}</li>
                                    <li>é€‰å€åŒ¹é…: ${report.dimensionScores.location}åˆ† - ${report.dimensionScores.location >= 80 ? 'ä¼˜ç§€âœ“' : report.dimensionScores.location >= 60 ? 'è‰¯å¥½' : 'å¾…æ”¹è¿›âš ï¸'}</li>
                                </ul>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                <div style="font-weight: 600; margin-bottom: 10px; color: #1f2937;">ğŸ¯ æ ¸å¿ƒå»ºè®®:</div>
                                <ol style="margin: 0; padding-left: 20px;">
                                    ${report.actionPlans.length > 0 ? `
                                    <li style="margin: 8px 0;">
                                        <strong>ä¼˜å…ˆå¤„ç†:</strong> ${report.actionPlans[0].problem},
                                        é¢„è®¡æŠ•å…¥${report.actionPlans[0].solutions[0].cost},
                                        ${report.actionPlans[0].solutions[0].timeline}å³å¯è§æ•ˆ
                                    </li>
                                    ` : ''}
                                    ${kpi.gross_margin < 0.55 ? `
                                    <li style="margin: 8px 0;">
                                        <strong>æå‡æ¯›åˆ©:</strong> é€šè¿‡æˆæœ¬ä¼˜åŒ–å’Œå®¢å•ä»·æå‡,ç›®æ ‡æ¯›åˆ©ç‡æå‡è‡³55%ä»¥ä¸Š,
                                        é¢„è®¡æœˆå¢æ”¶Â¥${Math.round(data.monthly_revenue * 0.1)}
                                    </li>
                                    ` : ''}
                                    ${kpi.member_repurchase < 0.25 ? `
                                    <li style="margin: 8px 0;">
                                        <strong>æå‡å¤è´­:</strong> å»ºç«‹ä¼šå‘˜ä½“ç³»å’Œå®¢æˆ·å…³ç³»ç®¡ç†,ç›®æ ‡å¤è´­ç‡25%ä»¥ä¸Š,
                                        å¯æå‡æœˆè¥æ”¶10-15%
                                    </li>
                                    ` : ''}
                                    <li style="margin: 8px 0;">
                                        <strong>æŒç»­ä¼˜åŒ–:</strong> å»ºç«‹æœˆåº¦ç»è¥åˆ†æåˆ¶åº¦,å®šæœŸreviewæ ¸å¿ƒæŒ‡æ ‡,
                                        åŠæ—¶å‘ç°é—®é¢˜å¹¶è°ƒæ•´ç­–ç•¥
                                    </li>
                                </ol>
                            </div>

                            <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div style="font-weight: 600; margin-bottom: 10px; color: #92400e;">
                                    <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> é¢„æœŸæ”¹è¿›æ•ˆæœ:
                                </div>
                                <p style="margin: 0; color: #78350f;">
                                    æŒ‰ç…§ä»¥ä¸Šå»ºè®®ç³»ç»Ÿæ€§æ”¹è¿›,é¢„è®¡<strong>1-3ä¸ªæœˆ</strong>å†…å¯ä»¥çœ‹åˆ°æ˜æ˜¾æ•ˆæœ:
                                    ${report.overallScore < 60 ? 'æ•´ä½“è¯„åˆ†æå‡è‡³70åˆ†ä»¥ä¸Š,' : ''}
                                    ${kpi.gross_margin < 0.55 ? 'æ¯›åˆ©ç‡æå‡5-8%,' : ''}
                                    æœˆè¥æ”¶å¢é•¿<strong>15-25%</strong>,
                                    æœˆå‡€åˆ©æ¶¦å¢åŠ <strong>Â¥${Math.round(data.monthly_revenue * 0.15 * 0.5)}-Â¥${Math.round(data.monthly_revenue * 0.25 * 0.5)}</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ä¸‹æ¬¡è¯Šæ–­å»ºè®®
            html += `
                <div class="diagnosis-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px dashed #3b82f6;">
                    <h3 style="color: #1e40af;">ğŸ’¡ ä¸‹æ¬¡è¯Šæ–­å»ºè®®</h3>
                    <p style="font-size: 14px; line-height: 1.8; color: #1e40af;">
                        å»ºè®®<strong>1ä¸ªæœˆå</strong>è¿›è¡Œä¸‹æ¬¡è¯Šæ–­,å¯¹æ¯”æœ¬æ¬¡æŠ¥å‘Šæ•°æ®,è¯„ä¼°æ”¹è¿›æ•ˆæœã€‚
                        é‡ç‚¹å…³æ³¨æŒ‡æ ‡: 
                        ${kpi.gross_margin < 0.55 ? 'æ¯›åˆ©ç‡ã€' : ''}
                        ${kpi.table_turnover < 3 ? 'ç¿»å°ç‡ã€' : ''}
                        ${kpi.negative_comment_rate > 0.05 ? 'å·®è¯„ç‡ã€' : ''}
                        ${kpi.member_repurchase < 0.25 ? 'å¤è´­ç‡ã€' : ''}
                        å®¢å•ä»·ã€æœˆè¥æ”¶ç­‰ã€‚
                    </p>
                    <p style="font-size: 13px; color: #64748b; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> 
                        æŒç»­è¿½è¸ªç»è¥æ•°æ®,å»ºç«‹æœˆåº¦è¯Šæ–­æœºåˆ¶,å¯ä»¥æ›´åŠæ—¶å‘ç°é—®é¢˜å¹¶ä¼˜åŒ–ç­–ç•¥ã€‚
                    </p>
                </div>
            `;

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function changeTheme(theme) {
            const reportExport = document.getElementById('reportExport');
            reportExport.className = `diagnosis-report-v2 theme-${theme}`;
            
            // ä¿å­˜ä¸»é¢˜é€‰æ‹©
            localStorage.setItem('selectedTheme', theme);
        }

        // PDFå¯¼å‡ºåŠŸèƒ½
        function exportToPDF() {
            const reportContent = document.getElementById('reportExport');
            const storeName = currentRecord?.store_name || 'é¤é¥®åº—';
            
            if (typeof html2pdf !== 'undefined') {
                const opt = {
                    margin: 1,
                    filename: `${storeName}_è¯Šæ–­æŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };
                
                html2pdf().set(opt).from(reportContent).save();
            } else {
                alert('PDFå¯¼å‡ºåŠŸèƒ½éœ€è¦åŠ è½½html2pdfåº“');
            }
        }

        // å›¾ç‰‡å¯¼å‡ºåŠŸèƒ½
        function exportToImage() {
            const reportContent = document.getElementById('reportExport');
            const storeName = currentRecord?.store_name || 'é¤é¥®åº—';
            
            html2canvas(reportContent, {
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${storeName}_è¯Šæ–­æŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥:', error);
                alert('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'fresh';
            const themeSelector = document.getElementById('themeSelector');
            if (themeSelector) {
                themeSelector.value = savedTheme;
                changeTheme(savedTheme);
            }
        });

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            totalCount.textContent = totalRecords.toLocaleString();
            currentCount.textContent = currentData.length;
            
            if (currentData.length > 0) {
                const latest = new Date(currentData[0].timestamp).toLocaleDateString();
                latestRecord.textContent = latest;
            }
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / limit);
            pageInfo.textContent = `é¡µ ${currentPage} / ${totalPages}`;
            
            prevPage.disabled = currentPage <= 1;
            nextPage.disabled = currentPage >= totalPages;
        }

        // ä¸‹è½½CSV
        async function downloadCSV() {
            const api = apiUrl.value.trim();
            const key = adminKey.value.trim();

            if (!api || !key) {
                alert('è¯·å…ˆé…ç½®APIåœ°å€å’Œç®¡ç†å‘˜å¯†é’¥');
                return;
            }

            try {
                const response = await fetch(`${api}/api/export`, {
                    method: 'GET',
                    headers: { 'x-admin-key': key }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `surveys_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(type, message) {
            statusText.textContent = message;
            statusDisplay.className = 'p-3 rounded-lg mb-4';
            statusIndicator.className = 'w-3 h-3 rounded-full mr-2';

            switch(type) {
                case 'connected':
                    statusDisplay.classList.add('bg-green-100', 'text-green-800');
                    statusIndicator.classList.add('bg-green-500');
                    break;
                case 'checking':
                    statusDisplay.classList.add('bg-yellow-100', 'text-yellow-800');
                    statusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'error':
                    statusDisplay.classList.add('bg-red-100', 'text-red-800');
                    statusIndicator.classList.add('bg-red-500');
                    break;
            }
            statusDisplay.classList.remove('hidden');
        }

        // åˆ‡æ¢åŠ è½½çŠ¶æ€
        function toggleLoading(loading) {
            const loadingElement = loadData.querySelector('.loading');
            const textElement = loadData.querySelector('.load-text');
            
            if (loading) {
                loadingElement.classList.add('active');
                textElement.style.display = 'none';
                loadData.disabled = true;
            } else {
                loadingElement.classList.remove('active');
                textElement.style.display = 'flex';
                loadData.disabled = false;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString('zh-CN');
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString();
        }
    </script>
</body>
</html>
