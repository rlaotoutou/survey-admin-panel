class RestaurantDiagnosisAdvanced{constructor(){this.thresholds={food_cost_ratio: 0.35,labor_cost_ratio: 0.30,rent_cost_ratio: 0.20,marketing_cost_ratio: 0.10,utility_cost_ratio: 0.05,gross_margin: 0.55,table_turnover: 3.0,revenue_per_sqm: 5000,revenue_per_employee: 30000,avg_spending: 50,member_repurchase: 0.25,takeaway_ratio: [0.3,0.5],review_score: 4.0,negative_comment_rate: 0.05,content_marketing_index: 60,short_video_count: 50,live_stream_count: 15,service_bad_review_rate: 0.30,taste_bad_review_rate: 0.30};this.industryBenchmarks={'å¿«é¤':{table_turnover: 4.5,gross_margin: 0.60,takeaway_ratio: 0.4,revenue_per_sqm: 6000,avg_spending: 35},'ç«é”…':{table_turnover: 3.5,gross_margin: 0.65,takeaway_ratio: 0.3,revenue_per_sqm: 7000,avg_spending: 80},'æ­£é¤':{table_turnover: 2.5,gross_margin: 0.58,takeaway_ratio: 0.25,revenue_per_sqm: 5500,avg_spending: 70},'èŒ¶é¤å…':{table_turnover: 3.0,gross_margin: 0.55,takeaway_ratio: 0.3,revenue_per_sqm: 5000,avg_spending: 45},'å’–å•¡å…':{table_turnover: 2.0,gross_margin: 0.70,takeaway_ratio: 0.4,revenue_per_sqm: 4500,avg_spending: 40},'èŒ¶é¥®åº—':{table_turnover: 5.0,gross_margin: 0.65,takeaway_ratio: 0.6,revenue_per_sqm: 8000,avg_spending: 25},'å…¶ä»–':{table_turnover: 3.0,gross_margin: 0.55,takeaway_ratio: 0.3,revenue_per_sqm: 5000,avg_spending: 50}};this.businessCircleScores={'ä¸€ç±»å•†åœºé‡Œé¢': 95,'äºŒç±»å•†åœºé‡Œé¢': 85,'ä¸€ç±»å•†åœˆ': 90,'äºŒç±»å•†åœˆ': 80,'ä¸€ç±»ä¸»è¡—': 85,'äºŒç±»ä¸»è¡—': 75,'ä¸€ç±»ç¤¾åŒº': 70,'äºŒç±»ç¤¾åŒº': 60};this.decorationScores={'ä¸­é«˜æ¡£': 90,'ä¸­æ¡£': 75,'ä¸­ä½æ¡£': 60};this.cache=new Map()}calculateKPI(data){const cacheKey=`kpi_${JSON.stringify(data)}`;if(this.cache.has(cacheKey)){return this.cache.get(cacheKey)}const totalCost=(data.food_cost || 0)+(data.labor_cost || 0)+(data.rent_cost || 0)+(data.marketing_cost || 0)+(data.utility_cost || 0);const estimatedEmployees=Math.max(1,Math.round((data.labor_cost || 0)/5000));const kpi={food_cost_ratio:(data.food_cost || 0)/(data.monthly_revenue || 1),labor_cost_ratio:(data.labor_cost || 0)/(data.monthly_revenue || 1),rent_cost_ratio:(data.rent_cost || 0)/(data.monthly_revenue || 1),marketing_cost_ratio:(data.marketing_cost || 0)/(data.monthly_revenue || 1),utility_cost_ratio:(data.utility_cost || 0)/(data.monthly_revenue || 1),gross_margin: 1-(totalCost/(data.monthly_revenue || 1)),table_turnover:(data.daily_customers || 0)/(data.seats || 1),revenue_per_sqm:(data.monthly_revenue || 0)/(data.store_area || 1),revenue_per_employee:(data.monthly_revenue || 0)/estimatedEmployees,avg_spending:(data.monthly_revenue || 0)/(data.total_customers || 1),member_repurchase:(data.repeat_customers || 0)/(data.total_customers || 1),takeaway_ratio:(data.online_revenue || 0)/(data.monthly_revenue || 1),review_score: data.average_rating || 0,negative_comment_rate:(data.bad_reviews || 0)/(data.total_reviews || 1),content_marketing_index: this.calculateContentMarketingIndex(data),short_video_count: data.short_video_count || 0,live_stream_count: data.live_stream_count || 0,service_bad_review_rate:(data.service_bad_reviews || 0)/(data.bad_reviews || 1),taste_bad_review_rate:(data.taste_bad_reviews || 0)/(data.bad_reviews || 1),location_match_score: this.calculateLocationMatchScore(data),marketing_health_score: this.calculateMarketingHealthScore(data),estimated_employees: estimatedEmployees};this.cache.set(cacheKey,kpi);return kpi}calculateContentMarketingIndex(data){let score=0;const videoScore=Math.min(40,(data.short_video_count || 0)/100*40);score+=videoScore;const liveScore=Math.min(30,(data.live_stream_count || 0)/30*30);score+=liveScore;const marketingSituationScore={'æœ‰è‡ªå·±å›¢é˜Ÿ': 30,'æ‰¾ä»£è¿è¥': 25,'è€æ¿è¿è¥': 20,'æ— ': 0};score+=marketingSituationScore[data.marketing_situation] || 15;return Math.round(score)}calculateLocationMatchScore(data){let score=0;const circleScore=(this.businessCircleScores[data.business_circle] || 70)/100*40;score+=circleScore;const decorScore=(this.decorationScores[data.decoration_level] || 70)/100*30;score+=decorScore;const benchmark=this.industryBenchmarks[data.business_type] || this.industryBenchmarks['å…¶ä»–'];const revenuePerSqm=(data.monthly_revenue || 0)/(data.store_area || 1);const matchScore=Math.min(30,(revenuePerSqm/benchmark.revenue_per_sqm)*30);score+=matchScore;return Math.round(score)}calculateMarketingHealthScore(data){let score=0;const marketingRatio=(data.marketing_cost || 0)/(data.monthly_revenue || 1);const roiScore=Math.max(0,40-(marketingRatio*100*4));score+=roiScore;const onlineScore=Math.min(30,((data.average_rating || 0)/5)*30);score+=onlineScore;const contentScore=Math.min(30,((data.short_video_count || 0)/100)*30);score+=contentScore;return Math.round(score)}generateReport(data,kpi,benchmark){const totalCostCalc=(data.food_cost || 0)+(data.labor_cost || 0)+(data.rent_cost || 0)+(data.marketing_cost || 0)+(data.utility_cost || 0);return ` <div id="reportExport"> <div class="diagnosis-section"> <h3>ä¸€ã€ç»¼åˆå¥åº·åº¦è¯„åˆ†</h3> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="metric-card" style="border-top-color: #3b82f6;"> <div class="metric-label">é€‰å€åŒ¹é…åº¦</div> <div class="metric-value" style="font-size: 32px;color: #3b82f6;">${kpi.location_match_score}åˆ†</div> <div class="score-badge ${this.getScoreBadgeClass(kpi.location_match_score)}" style="margin-top: 8px;"> ${this.getScoreLabel(kpi.location_match_score)}</div> </div> <div class="metric-card" style="border-top-color: #10b981;"> <div class="metric-label">è¥é”€å¥åº·åº¦</div> <div class="metric-value" style="font-size: 32px;color: #10b981;">${kpi.marketing_health_score}åˆ†</div> <div class="score-badge ${this.getScoreBadgeClass(kpi.marketing_health_score)}" style="margin-top: 8px;"> ${this.getScoreLabel(kpi.marketing_health_score)}</div> </div> <div class="metric-card" style="border-top-color: #f59e0b;"> <div class="metric-label">å†…å®¹è¥é”€æŒ‡æ•°</div> <div class="metric-value" style="font-size: 32px;color: #f59e0b;">${kpi.content_marketing_index}åˆ†</div> <div class="score-badge ${this.getScoreBadgeClass(kpi.content_marketing_index)}" style="margin-top: 8px;"> ${this.getScoreLabel(kpi.content_marketing_index)}</div> </div> <div class="metric-card" style="border-top-color: #8b5cf6;"> <div class="metric-label">ç»¼åˆè¯„åˆ†</div> <div class="metric-value" style="font-size: 32px;color: #8b5cf6;">${Math.round((kpi.location_match_score+kpi.marketing_health_score+kpi.content_marketing_index)/3)}åˆ†</div> <div class="score-badge ${this.getScoreBadgeClass(Math.round((kpi.location_match_score+kpi.marketing_health_score+kpi.content_marketing_index)/3))}" style="margin-top: 8px;"> ${this.getScoreLabel(Math.round((kpi.location_match_score+kpi.marketing_health_score+kpi.content_marketing_index)/3))}</div> </div> </div> </div> <div class="diagnosis-section"> <h3>äºŒã€æˆæœ¬ç»“æ„æ·±åº¦åˆ†æ</h3> <div class="info-card"> <h4 style="font-weight: 600;margin-bottom: 10px;">ğŸ“Š æˆæœ¬æ„æˆæ˜ç»†</h4> <table class="health-table"> <thead> <tr> <th>æˆæœ¬é¡¹ç›®</th> <th>é‡‘é¢(å…ƒ/æœˆ)</th> <th>å æ¯”</th> <th>å¥åº·çŠ¶æ€</th> </tr> </thead> <tbody> <tr> <td>é£Ÿææˆæœ¬</td> <td>Â¥${this.formatNumber(data.food_cost)}</td> <td>${(kpi.food_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.food_cost_ratio <=0.35 ? 'status-healthy' : kpi.food_cost_ratio <=0.40 ? 'status-warning' : 'status-danger'}"> ${kpi.food_cost_ratio <=0.35 ? 'å¥åº·' : kpi.food_cost_ratio <=0.40 ? 'è­¦å‘Š' : 'å±é™©'}</td> </tr> <tr> <td>äººåŠ›æˆæœ¬</td> <td>Â¥${this.formatNumber(data.labor_cost)}</td> <td>${(kpi.labor_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.labor_cost_ratio <=0.30 ? 'status-healthy' : kpi.labor_cost_ratio <=0.35 ? 'status-warning' : 'status-danger'}"> ${kpi.labor_cost_ratio <=0.30 ? 'å¥åº·' : kpi.labor_cost_ratio <=0.35 ? 'è­¦å‘Š' : 'å±é™©'}</td> </tr> <tr> <td>ç§Ÿé‡‘æˆæœ¬</td> <td>Â¥${this.formatNumber(data.rent_cost)}</td> <td>${(kpi.rent_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.rent_cost_ratio <=0.20 ? 'status-healthy' : kpi.rent_cost_ratio <=0.25 ? 'status-warning' : 'status-danger'}"> ${kpi.rent_cost_ratio <=0.20 ? 'å¥åº·' : kpi.rent_cost_ratio <=0.25 ? 'è­¦å‘Š' : 'å±é™©'}</td> </tr> <tr> <td>è¥é”€è´¹ç”¨</td> <td>Â¥${this.formatNumber(data.marketing_cost)}</td> <td>${(kpi.marketing_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.marketing_cost_ratio <=0.10 ? 'status-healthy' : kpi.marketing_cost_ratio <=0.15 ? 'status-warning' : 'status-danger'}"> ${kpi.marketing_cost_ratio <=0.10 ? 'å¥åº·' : kpi.marketing_cost_ratio <=0.15 ? 'è­¦å‘Š' : 'å±é™©'}</td> </tr> <tr> <td>æ°´ç”µæ°”æˆæœ¬</td> <td>Â¥${this.formatNumber(data.utility_cost)}</td> <td>${(kpi.utility_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.utility_cost_ratio <=0.05 ? 'status-healthy' : kpi.utility_cost_ratio <=0.08 ? 'status-warning' : 'status-danger'}"> ${kpi.utility_cost_ratio <=0.05 ? 'å¥åº·' : kpi.utility_cost_ratio <=0.08 ? 'è­¦å‘Š' : 'å±é™©'}</td> </tr> <tr style="background: #f0f9ff;"> <td><strong>æ€»æˆæœ¬</strong></td> <td><strong>Â¥${this.formatNumber(totalCostCalc)}</strong></td> <td><strong>${((totalCostCalc/data.monthly_revenue)*100).toFixed(1)}%</strong></td> <td class="${kpi.gross_margin >=0.55 ? 'status-healthy' : kpi.gross_margin >=0.45 ? 'status-warning' : 'status-danger'}"> æ¯›åˆ©${(kpi.gross_margin*100).toFixed(1)}% </td> </tr> </tbody> </table> </div> <!--æˆæœ¬ä¼˜åŒ–å»ºè®®--> <div class="info-card"> <h4 style="font-weight: 600;margin-bottom: 10px;">ğŸ’¡ æˆæœ¬ä¼˜åŒ–å»ºè®®</h4> ${this.generateCostOptimizationAdvice(kpi,data)}</div> </div> <div class="diagnosis-section"> <h3>ä¸‰ã€æ•ˆç‡æŒ‡æ ‡åˆ†æ</h3> <div class="grid grid-cols-1 md:grid-cols-3 gap-4"> <div class="metric-card" style="border-top-color: #6366f1;"> <div class="metric-label">ç¿»å°ç‡</div> <div class="metric-value" style="font-size: 24px;color: #6366f1;">${kpi.table_turnover.toFixed(1)}æ¬¡</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> è¡Œä¸šå¹³å‡: ${benchmark.table_turnover}æ¬¡ </div> </div> <div class="metric-card" style="border-top-color: #ec4899;"> <div class="metric-label">åªæ•ˆ</div> <div class="metric-value" style="font-size: 24px;color: #ec4899;">Â¥${Math.round(kpi.revenue_per_sqm)}</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> è¡Œä¸šå¹³å‡: Â¥${benchmark.revenue_per_sqm}</div> </div> <div class="metric-card" style="border-top-color: #14b8a6;"> <div class="metric-label">äººæ•ˆ</div> <div class="metric-value" style="font-size: 24px;color: #14b8a6;">Â¥${Math.round(kpi.revenue_per_employee)}</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> è¡Œä¸šå¹³å‡: Â¥${this.thresholds.revenue_per_employee}</div> </div> </div> </div> <div class="diagnosis-section"> <h3>å››ã€å®¢æˆ·è¡Œä¸ºåˆ†æ</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div class="metric-card" style="border-top-color: #6366f1;"> <div class="metric-label">å®¢å•ä»·</div> <div class="metric-value" style="font-size: 24px;color: #6366f1;">Â¥${Math.round(kpi.avg_spending)}</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> è¡Œä¸šå¹³å‡: Â¥${benchmark.avg_spending || 50}</div> </div> <div class="metric-card" style="border-top-color: #ec4899;"> <div class="metric-label">å¤è´­ç‡</div> <div class="metric-value" style="font-size: 24px;color: #ec4899;">${(kpi.member_repurchase*100).toFixed(1)}%</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> ${kpi.member_repurchase >=0.25 ? 'ä¼˜ç§€æ°´å¹³' : kpi.member_repurchase >=0.15 ? 'åˆæ ¼æ°´å¹³' : 'éœ€æå‡'}</div> </div> </div> </div> <div class="diagnosis-section"> <h3>äº”ã€çº¿ä¸Šè¡¨ç°åˆ†æ</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div class="metric-card" style="border-top-color: #f59e0b;"> <div class="metric-label">å¹³å‡è¯„åˆ†</div> <div class="metric-value" style="font-size: 24px;color: #f59e0b;">${kpi.review_score}åˆ†</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> ${kpi.review_score >=4.5 ? 'ä¼˜ç§€' : kpi.review_score >=4.0 ? 'è‰¯å¥½' : 'éœ€æå‡'}</div> </div> <div class="metric-card" style="border-top-color: #8b5cf6;"> <div class="metric-label">å·®è¯„ç‡</div> <div class="metric-value" style="font-size: 24px;color: #8b5cf6;">${(kpi.negative_comment_rate*100).toFixed(1)}%</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> ${kpi.negative_comment_rate <=0.05 ? 'å¥åº·' : kpi.negative_comment_rate <=0.10 ? 'è­¦å‘Š' : 'å±é™©'}</div> </div> </div> </div> </div> `}generateCostOptimizationAdvice(kpi,data){let advice='';if(kpi.food_cost_ratio > 0.35){advice+=` <div style="margin: 12px 0;padding: 12px;background: #fef2f2;border-left: 3px solid #ef4444;border-radius: 4px;"> <strong>é£Ÿææˆæœ¬åé«˜:</strong> <ul style="margin: 8px 0 0 20px;font-size: 13px;line-height: 1.8;"> <li>å»ºç«‹æ ‡å‡†åŒ–é…æ–¹,ä¸¥æ ¼æ§åˆ¶å‡ºå“ä»½é‡</li> <li>ä¼˜åŒ–é‡‡è´­æ¸ é“,å¯»æ±‚æ‰¹é‡è®®ä»·</li> <li>é™ä½æŸè€—ç‡,æ”¹è¿›åº“å­˜ç®¡ç†</li> <li>é¢„è®¡å¯é™ä½æˆæœ¬ç‡3-5%,æœˆèŠ‚çœÂ¥${this.formatNumber(Math.round(data.monthly_revenue*0.04))}</li> </ul> </div> `}if(kpi.labor_cost_ratio > 0.30){advice+=` <div style="margin: 12px 0;padding: 12px;background: #fef2f2;border-left: 3px solid #ef4444;border-radius: 4px;"> <strong>äººåŠ›æˆæœ¬åé«˜:</strong> <ul style="margin: 8px 0 0 20px;font-size: 13px;line-height: 1.8;"> <li>ä¼˜åŒ–æ’ç­,æé«˜äººæ•ˆ</li> <li>å¼•å…¥è‡ªåŠ©ç‚¹é¤ç­‰é™æœ¬å·¥å…·</li> <li>æŒ‰é«˜å³°æ—¶æ®µå¼¹æ€§é…ç½®äººå‘˜</li> <li>é¢„è®¡å¯æå‡äººæ•ˆ20%,æœˆèŠ‚çœÂ¥${this.formatNumber(Math.round(data.labor_cost*0.15))}</li> </ul> </div> `}if(kpi.marketing_cost_ratio > 0.10){advice+=` <div style="margin: 12px 0;padding: 12px;background: #fef2f2;border-left: 3px solid #ef4444;border-radius: 4px;"> <strong>è¥é”€æˆæœ¬åé«˜:</strong> <ul style="margin: 8px 0 0 20px;font-size: 13px;line-height: 1.8;"> <li>ä¼˜åŒ–æŠ•æµç­–ç•¥,æé«˜ROI</li> <li>å»ºç«‹ç§åŸŸæµé‡,é™ä½å¹³å°ä¾èµ–</li> <li>åŠ å¼ºå†…å®¹è¥é”€,æå‡è‡ªç„¶æµé‡</li> <li>é¢„è®¡å¯é™ä½è·å®¢æˆæœ¬25%,æœˆèŠ‚çœÂ¥${this.formatNumber(Math.round(data.marketing_cost*0.25))}</li> </ul> </div> `}if(kpi.food_cost_ratio <=0.35 && kpi.labor_cost_ratio <=0.30 && kpi.marketing_cost_ratio <=0.10){advice+=` <div style="padding: 12px;background: #f0fdf4;border-left: 3px solid #22c55e;border-radius: 4px;"> <p style="color: #22c55e;font-weight: 600;">âœ“ æˆæœ¬æ§åˆ¶è‰¯å¥½,ç»§ç»­ä¿æŒ!</p> </div> `}return advice}getScoreBadgeClass(score){if(score >=80)return 'score-excellent';if(score >=70)return 'score-good';if(score >=60)return 'score-average';return 'score-poor'}getScoreLabel(score){if(score >=80)return 'ä¼˜ç§€';if(score >=70)return 'è‰¯å¥½';if(score >=60)return 'ä¸€èˆ¬';return 'éœ€æ”¹è¿›'}formatNumber(num){if(!num)return '0';return new Intl.NumberFormat('zh-CN').format(num)}}