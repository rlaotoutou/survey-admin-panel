class RestaurantDiagnosisAdvanced{constructor(){this.thresholds={food_cost_ratio: 0.35,labor_cost_ratio: 0.30,rent_cost_ratio: 0.20,marketing_cost_ratio: 0.10,utility_cost_ratio: 0.05,gross_margin: 0.55,table_turnover: 3.0,revenue_per_sqm: 5000,revenue_per_employee: 30000,avg_spending: 50,member_repurchase: 0.25,takeaway_ratio: [0.3,0.5],review_score: 4.0,negative_comment_rate: 0.05,content_marketing_index: 60,short_video_count: 50,live_stream_count: 15,service_bad_review_rate: 0.30,taste_bad_review_rate: 0.30};this.industryBenchmarks={'快餐':{table_turnover: 4.5,gross_margin: 0.60,takeaway_ratio: 0.4,revenue_per_sqm: 6000,avg_spending: 35},'火锅':{table_turnover: 3.5,gross_margin: 0.65,takeaway_ratio: 0.3,revenue_per_sqm: 7000,avg_spending: 80},'正餐':{table_turnover: 2.5,gross_margin: 0.58,takeaway_ratio: 0.25,revenue_per_sqm: 5500,avg_spending: 70},'茶餐厅':{table_turnover: 3.0,gross_margin: 0.55,takeaway_ratio: 0.3,revenue_per_sqm: 5000,avg_spending: 45},'咖啡厅':{table_turnover: 2.0,gross_margin: 0.70,takeaway_ratio: 0.4,revenue_per_sqm: 4500,avg_spending: 40},'茶饮店':{table_turnover: 5.0,gross_margin: 0.65,takeaway_ratio: 0.6,revenue_per_sqm: 8000,avg_spending: 25},'其他':{table_turnover: 3.0,gross_margin: 0.55,takeaway_ratio: 0.3,revenue_per_sqm: 5000,avg_spending: 50}};this.businessCircleScores={'一类商场里面': 95,'二类商场里面': 85,'一类商圈': 90,'二类商圈': 80,'一类主街': 85,'二类主街': 75,'一类社区': 70,'二类社区': 60};this.decorationScores={'中高档': 90,'中档': 75,'中低档': 60};this.cache=new Map()}calculateKPI(data){const cacheKey=`kpi_${JSON.stringify(data)}`;if(this.cache.has(cacheKey)){return this.cache.get(cacheKey)}const totalCost=(data.food_cost || 0)+(data.labor_cost || 0)+(data.rent_cost || 0)+(data.marketing_cost || 0)+(data.utility_cost || 0);const estimatedEmployees=Math.max(1,Math.round((data.labor_cost || 0)/5000));const kpi={food_cost_ratio:(data.food_cost || 0)/(data.monthly_revenue || 1),labor_cost_ratio:(data.labor_cost || 0)/(data.monthly_revenue || 1),rent_cost_ratio:(data.rent_cost || 0)/(data.monthly_revenue || 1),marketing_cost_ratio:(data.marketing_cost || 0)/(data.monthly_revenue || 1),utility_cost_ratio:(data.utility_cost || 0)/(data.monthly_revenue || 1),gross_margin: 1-(totalCost/(data.monthly_revenue || 1)),table_turnover:(data.daily_customers || 0)/(data.seats || 1),revenue_per_sqm:(data.monthly_revenue || 0)/(data.store_area || 1),revenue_per_employee:(data.monthly_revenue || 0)/estimatedEmployees,avg_spending:(data.monthly_revenue || 0)/(data.total_customers || 1),member_repurchase:(data.repeat_customers || 0)/(data.total_customers || 1),takeaway_ratio:(data.online_revenue || 0)/(data.monthly_revenue || 1),review_score: data.average_rating || 0,negative_comment_rate:(data.bad_reviews || 0)/(data.total_reviews || 1),content_marketing_index: this.calculateContentMarketingIndex(data),short_video_count: data.short_video_count || 0,live_stream_count: data.live_stream_count || 0,service_bad_review_rate:(data.service_bad_reviews || 0)/(data.bad_reviews || 1),taste_bad_review_rate:(data.taste_bad_reviews || 0)/(data.bad_reviews || 1),location_match_score: this.calculateLocationMatchScore(data),marketing_health_score: this.calculateMarketingHealthScore(data),estimated_employees: estimatedEmployees};this.cache.set(cacheKey,kpi);return kpi}calculateContentMarketingIndex(data){let score=0;const videoScore=Math.min(40,(data.short_video_count || 0)/100*40);score+=videoScore;const liveScore=Math.min(30,(data.live_stream_count || 0)/30*30);score+=liveScore;const marketingSituationScore={'有自己团队': 30,'找代运营': 25,'老板运营': 20,'无': 0};score+=marketingSituationScore[data.marketing_situation] || 15;return Math.round(score)}calculateLocationMatchScore(data){let score=0;const circleScore=(this.businessCircleScores[data.business_circle] || 70)/100*40;score+=circleScore;const decorScore=(this.decorationScores[data.decoration_level] || 70)/100*30;score+=decorScore;const benchmark=this.industryBenchmarks[data.business_type] || this.industryBenchmarks['其他'];const revenuePerSqm=(data.monthly_revenue || 0)/(data.store_area || 1);const matchScore=Math.min(30,(revenuePerSqm/benchmark.revenue_per_sqm)*30);score+=matchScore;return Math.round(score)}calculateMarketingHealthScore(data){let score=0;const marketingRatio=(data.marketing_cost || 0)/(data.monthly_revenue || 1);const roiScore=Math.max(0,40-(marketingRatio*100*4));score+=roiScore;const onlineScore=Math.min(30,((data.average_rating || 0)/5)*30);score+=onlineScore;const contentScore=Math.min(30,((data.short_video_count || 0)/100)*30);score+=contentScore;return Math.round(score)}generateReport(data,kpi,benchmark){const totalCostCalc=(data.food_cost || 0)+(data.labor_cost || 0)+(data.rent_cost || 0)+(data.marketing_cost || 0)+(data.utility_cost || 0);return ` <div id="reportExport"> <div class="diagnosis-section"> <h3>一、综合健康度评分</h3> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="metric-card" style="border-top-color: #3b82f6;"> <div class="metric-label">选址匹配度</div> <div class="metric-value" style="font-size: 32px;color: #3b82f6;">${kpi.location_match_score}分</div> <div class="score-badge ${this.getScoreBadgeClass(kpi.location_match_score)}" style="margin-top: 8px;"> ${this.getScoreLabel(kpi.location_match_score)}</div> </div> <div class="metric-card" style="border-top-color: #10b981;"> <div class="metric-label">营销健康度</div> <div class="metric-value" style="font-size: 32px;color: #10b981;">${kpi.marketing_health_score}分</div> <div class="score-badge ${this.getScoreBadgeClass(kpi.marketing_health_score)}" style="margin-top: 8px;"> ${this.getScoreLabel(kpi.marketing_health_score)}</div> </div> <div class="metric-card" style="border-top-color: #f59e0b;"> <div class="metric-label">内容营销指数</div> <div class="metric-value" style="font-size: 32px;color: #f59e0b;">${kpi.content_marketing_index}分</div> <div class="score-badge ${this.getScoreBadgeClass(kpi.content_marketing_index)}" style="margin-top: 8px;"> ${this.getScoreLabel(kpi.content_marketing_index)}</div> </div> <div class="metric-card" style="border-top-color: #8b5cf6;"> <div class="metric-label">综合评分</div> <div class="metric-value" style="font-size: 32px;color: #8b5cf6;">${Math.round((kpi.location_match_score+kpi.marketing_health_score+kpi.content_marketing_index)/3)}分</div> <div class="score-badge ${this.getScoreBadgeClass(Math.round((kpi.location_match_score+kpi.marketing_health_score+kpi.content_marketing_index)/3))}" style="margin-top: 8px;"> ${this.getScoreLabel(Math.round((kpi.location_match_score+kpi.marketing_health_score+kpi.content_marketing_index)/3))}</div> </div> </div> </div> <div class="diagnosis-section"> <h3>二、成本结构深度分析</h3> <div class="info-card"> <h4 style="font-weight: 600;margin-bottom: 10px;">📊 成本构成明细</h4> <table class="health-table"> <thead> <tr> <th>成本项目</th> <th>金额(元/月)</th> <th>占比</th> <th>健康状态</th> </tr> </thead> <tbody> <tr> <td>食材成本</td> <td>¥${this.formatNumber(data.food_cost)}</td> <td>${(kpi.food_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.food_cost_ratio <=0.35 ? 'status-healthy' : kpi.food_cost_ratio <=0.40 ? 'status-warning' : 'status-danger'}"> ${kpi.food_cost_ratio <=0.35 ? '健康' : kpi.food_cost_ratio <=0.40 ? '警告' : '危险'}</td> </tr> <tr> <td>人力成本</td> <td>¥${this.formatNumber(data.labor_cost)}</td> <td>${(kpi.labor_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.labor_cost_ratio <=0.30 ? 'status-healthy' : kpi.labor_cost_ratio <=0.35 ? 'status-warning' : 'status-danger'}"> ${kpi.labor_cost_ratio <=0.30 ? '健康' : kpi.labor_cost_ratio <=0.35 ? '警告' : '危险'}</td> </tr> <tr> <td>租金成本</td> <td>¥${this.formatNumber(data.rent_cost)}</td> <td>${(kpi.rent_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.rent_cost_ratio <=0.20 ? 'status-healthy' : kpi.rent_cost_ratio <=0.25 ? 'status-warning' : 'status-danger'}"> ${kpi.rent_cost_ratio <=0.20 ? '健康' : kpi.rent_cost_ratio <=0.25 ? '警告' : '危险'}</td> </tr> <tr> <td>营销费用</td> <td>¥${this.formatNumber(data.marketing_cost)}</td> <td>${(kpi.marketing_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.marketing_cost_ratio <=0.10 ? 'status-healthy' : kpi.marketing_cost_ratio <=0.15 ? 'status-warning' : 'status-danger'}"> ${kpi.marketing_cost_ratio <=0.10 ? '健康' : kpi.marketing_cost_ratio <=0.15 ? '警告' : '危险'}</td> </tr> <tr> <td>水电气成本</td> <td>¥${this.formatNumber(data.utility_cost)}</td> <td>${(kpi.utility_cost_ratio*100).toFixed(1)}%</td> <td class="${kpi.utility_cost_ratio <=0.05 ? 'status-healthy' : kpi.utility_cost_ratio <=0.08 ? 'status-warning' : 'status-danger'}"> ${kpi.utility_cost_ratio <=0.05 ? '健康' : kpi.utility_cost_ratio <=0.08 ? '警告' : '危险'}</td> </tr> <tr style="background: #f0f9ff;"> <td><strong>总成本</strong></td> <td><strong>¥${this.formatNumber(totalCostCalc)}</strong></td> <td><strong>${((totalCostCalc/data.monthly_revenue)*100).toFixed(1)}%</strong></td> <td class="${kpi.gross_margin >=0.55 ? 'status-healthy' : kpi.gross_margin >=0.45 ? 'status-warning' : 'status-danger'}"> 毛利${(kpi.gross_margin*100).toFixed(1)}% </td> </tr> </tbody> </table> </div> <!--成本优化建议--> <div class="info-card"> <h4 style="font-weight: 600;margin-bottom: 10px;">💡 成本优化建议</h4> ${this.generateCostOptimizationAdvice(kpi,data)}</div> </div> <div class="diagnosis-section"> <h3>三、效率指标分析</h3> <div class="grid grid-cols-1 md:grid-cols-3 gap-4"> <div class="metric-card" style="border-top-color: #6366f1;"> <div class="metric-label">翻台率</div> <div class="metric-value" style="font-size: 24px;color: #6366f1;">${kpi.table_turnover.toFixed(1)}次</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> 行业平均: ${benchmark.table_turnover}次 </div> </div> <div class="metric-card" style="border-top-color: #ec4899;"> <div class="metric-label">坪效</div> <div class="metric-value" style="font-size: 24px;color: #ec4899;">¥${Math.round(kpi.revenue_per_sqm)}</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> 行业平均: ¥${benchmark.revenue_per_sqm}</div> </div> <div class="metric-card" style="border-top-color: #14b8a6;"> <div class="metric-label">人效</div> <div class="metric-value" style="font-size: 24px;color: #14b8a6;">¥${Math.round(kpi.revenue_per_employee)}</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> 行业平均: ¥${this.thresholds.revenue_per_employee}</div> </div> </div> </div> <div class="diagnosis-section"> <h3>四、客户行为分析</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div class="metric-card" style="border-top-color: #6366f1;"> <div class="metric-label">客单价</div> <div class="metric-value" style="font-size: 24px;color: #6366f1;">¥${Math.round(kpi.avg_spending)}</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> 行业平均: ¥${benchmark.avg_spending || 50}</div> </div> <div class="metric-card" style="border-top-color: #ec4899;"> <div class="metric-label">复购率</div> <div class="metric-value" style="font-size: 24px;color: #ec4899;">${(kpi.member_repurchase*100).toFixed(1)}%</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> ${kpi.member_repurchase >=0.25 ? '优秀水平' : kpi.member_repurchase >=0.15 ? '合格水平' : '需提升'}</div> </div> </div> </div> <div class="diagnosis-section"> <h3>五、线上表现分析</h3> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div class="metric-card" style="border-top-color: #f59e0b;"> <div class="metric-label">平均评分</div> <div class="metric-value" style="font-size: 24px;color: #f59e0b;">${kpi.review_score}分</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> ${kpi.review_score >=4.5 ? '优秀' : kpi.review_score >=4.0 ? '良好' : '需提升'}</div> </div> <div class="metric-card" style="border-top-color: #8b5cf6;"> <div class="metric-label">差评率</div> <div class="metric-value" style="font-size: 24px;color: #8b5cf6;">${(kpi.negative_comment_rate*100).toFixed(1)}%</div> <div style="font-size: 12px;color: #666;margin-top: 4px;"> ${kpi.negative_comment_rate <=0.05 ? '健康' : kpi.negative_comment_rate <=0.10 ? '警告' : '危险'}</div> </div> </div> </div> </div> `}generateCostOptimizationAdvice(kpi,data){let advice='';if(kpi.food_cost_ratio > 0.35){advice+=` <div style="margin: 12px 0;padding: 12px;background: #fef2f2;border-left: 3px solid #ef4444;border-radius: 4px;"> <strong>食材成本偏高:</strong> <ul style="margin: 8px 0 0 20px;font-size: 13px;line-height: 1.8;"> <li>建立标准化配方,严格控制出品份量</li> <li>优化采购渠道,寻求批量议价</li> <li>降低损耗率,改进库存管理</li> <li>预计可降低成本率3-5%,月节省¥${this.formatNumber(Math.round(data.monthly_revenue*0.04))}</li> </ul> </div> `}if(kpi.labor_cost_ratio > 0.30){advice+=` <div style="margin: 12px 0;padding: 12px;background: #fef2f2;border-left: 3px solid #ef4444;border-radius: 4px;"> <strong>人力成本偏高:</strong> <ul style="margin: 8px 0 0 20px;font-size: 13px;line-height: 1.8;"> <li>优化排班,提高人效</li> <li>引入自助点餐等降本工具</li> <li>按高峰时段弹性配置人员</li> <li>预计可提升人效20%,月节省¥${this.formatNumber(Math.round(data.labor_cost*0.15))}</li> </ul> </div> `}if(kpi.marketing_cost_ratio > 0.10){advice+=` <div style="margin: 12px 0;padding: 12px;background: #fef2f2;border-left: 3px solid #ef4444;border-radius: 4px;"> <strong>营销成本偏高:</strong> <ul style="margin: 8px 0 0 20px;font-size: 13px;line-height: 1.8;"> <li>优化投流策略,提高ROI</li> <li>建立私域流量,降低平台依赖</li> <li>加强内容营销,提升自然流量</li> <li>预计可降低获客成本25%,月节省¥${this.formatNumber(Math.round(data.marketing_cost*0.25))}</li> </ul> </div> `}if(kpi.food_cost_ratio <=0.35 && kpi.labor_cost_ratio <=0.30 && kpi.marketing_cost_ratio <=0.10){advice+=` <div style="padding: 12px;background: #f0fdf4;border-left: 3px solid #22c55e;border-radius: 4px;"> <p style="color: #22c55e;font-weight: 600;">✓ 成本控制良好,继续保持!</p> </div> `}return advice}getScoreBadgeClass(score){if(score >=80)return 'score-excellent';if(score >=70)return 'score-good';if(score >=60)return 'score-average';return 'score-poor'}getScoreLabel(score){if(score >=80)return '优秀';if(score >=70)return '良好';if(score >=60)return '一般';return '需改进'}formatNumber(num){if(!num)return '0';return new Intl.NumberFormat('zh-CN').format(num)}}